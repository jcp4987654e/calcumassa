<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadoras Técnicas Eléctricas Unificadas</title>
    
    <!-- Scripts y Fuentes Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Script de MathJax para Fórmulas -->
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$']],
                displayMath: [['$$', '$$']]
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

    <!-- Estilos CSS Unificados y Mejorados -->
    <style>
        /* --- PALETA DE COLORES Y ESTILOS BASE --- */
        :root {
            --primary-color: #3B82F6; /* Azul primario */
            --primary-hover: #2563EB;
            --secondary-color: #4B5563; /* Gris oscuro */
            --header-bg: #1F2937; /* Azul muy oscuro para cabecera */
            --nav-bg: #374151; /* Gris azulado para navegación */
            --nav-active: #D97706; /* Naranja para el link activo */
            --body-bg: #F3F4F6; /* Gris claro para el fondo */
            --card-bg: #FFFFFF; /* Blanco para las tarjetas */
            --text-primary: #111827; /* Casi negro para texto principal */
            --text-secondary: #4B5563; /* Gris para texto secundario */
            --border-color: #E5E7EB; /* Borde suave */
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--body-bg); color: var(--text-primary); transition: background-color 0.3s; }
        header { background-color: var(--header-bg); color: #FFF; text-align: center; padding: 2rem 1rem; }
        header h1 { margin: 0; }
        nav { display: flex; flex-wrap: wrap; justify-content: center; background-color: var(--nav-bg); padding: 0.5rem; position: sticky; top: 0; z-index: 1000; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        nav a { color: #FFF; text-decoration: none; padding: 0.7rem 1.1rem; transition: background-color 0.3s ease, color 0.3s ease; border-radius: 6px; margin: 2px; display:inline-flex; align-items:center; gap: 0.5rem; }
        nav a:hover { background-color: var(--secondary-color); }
        nav a.active { background-color: var(--nav-active); font-weight: 600; }
        main { max-width: 1300px; margin: 2rem auto; padding: 1rem; }
        main > section { background-color: var(--card-bg); padding: 2rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); }
        main > section:not(:last-child) { margin-bottom: 2rem; }
        .hidden { display: none; }
        footer { text-align: center; padding: 1.5rem; margin-top: 2rem; background-color: var(--header-bg); color: #9CA3AF; }
        
        /* --- ESTILOS GENERALES PARA FORMULARIOS Y BOTONES --- */
        .input-group { margin-bottom: 1rem; }
        .input-group label { display: block; margin-bottom: 0.5rem; color: var(--text-secondary); font-weight: 500; font-size: 0.875rem; }
        .input-group input, .input-group select { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 0.5rem; transition: border-color 0.2s, box-shadow 0.2s; background-color: #F9FAFB; color: var(--text-primary); }
        .input-group input:focus, .input-group select:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.4); }
        .btn { padding: 0.75rem 1.5rem; border-radius: 0.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; display: inline-flex; align-items: center; justify-content: center; border: none; }
        .btn-sm { padding: 0.5rem 1rem; font-size: 0.875rem; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: var(--primary-hover); }
        .btn-danger { background-color: #EF4444; color: white; }
        .btn-danger:hover { background-color: #DC2626; }

        /* --- ESTILOS ESPECÍFICOS DE CALCULADORAS --- */
        
        /* Cortocircuito */
        .result-card { background-color: #f9fafb; border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1.5rem; margin-top: 1rem; }
        .result-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem 0; border-bottom: 1px solid var(--border-color); }
        .result-item:last-child { border-bottom: none; }
        .anexo-box { background-color: #EFF6FF; border-top: 3px solid var(--primary-color); padding: 2rem; margin-top: 3rem; border-radius: 0.75rem; }
        .anexo-box h3, .anexo-box h4 { color: var(--primary-hover); }
        .anexo-box p { color: #374151; }
        #seccion-cortocircuito table { width: 100%; text-align: left; border-collapse: collapse; font-size: 0.9rem; background-color: white; }
        #seccion-cortocircuito th, #seccion-cortocircuito td { padding: 0.75rem; border: 1px solid #d1d5db; text-align: center;}
        #seccion-cortocircuito th { background-color: #e5e7eb; font-weight: 600; }
        .feeder-node { border: 2px solid var(--primary-color); border-radius: 0.75rem; padding: 1.5rem; margin-top: 1.5rem; background-color: #fafbff; }
        .cable-node { border: 1px solid var(--border-color); border-radius: 0.75rem; padding: 1rem; margin-top: 1rem; background-color: white; }
        #diagramModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.85); z-index: 2000; display: none; justify-content: center; align-items: center; }
        #diagramModalContent { background-color: #fff; padding: 20px; border-radius: 10px; max-width: 95vw; max-height: 95vh; overflow: auto; }
        #closeDiagramModal { position: absolute; top: 15px; right: 25px; font-size: 35px; color: white; cursor: pointer; }

        /* Selección de Cables */
        #seccion-cables .tab-button-cables.active { border-bottom-color: var(--primary-color); color: var(--primary-color); font-weight: 600; }
        .ok-icon { color: #22c55e; }
        .fail-icon { color: #ef4444; }

        /* Puesta a Tierra (Tema claro unificado) */
        #seccion-tierra h1, #seccion-tierra h2, #seccion-tierra h3, #seccion-tierra h4 { color: var(--text-primary); }
        #seccion-tierra p, #seccion-tierra label, #seccion-tierra span { color: var(--text-secondary); }
        #seccion-tierra .sector-card { background-color: #F9FAFB; border: 1px solid var(--border-color); }
        #seccion-tierra .sector-card h4 { color: var(--text-primary); }
        #seccion-tierra .sector-card label { color: var(--text-secondary); }
        #seccion-tierra .tooltip-text { background-color: var(--header-bg); color: white; border-color: var(--nav-bg); }
        #seccion-tierra .tooltip-icon { background-color: var(--secondary-color); }
        #seccion-tierra .tab-button.active { border-color: var(--primary-color); color: var(--primary-color); background-color: transparent; }
        #seccion-tierra .tab-button { border-color: transparent; color: var(--text-secondary) }
        #seccion-tierra .tab-button:hover { color: var(--primary-color); }
        #seccion-tierra .result-section { display: none; }
        #seccion-tierra #results-container { background-color: #F9FAFB; border: 1px solid var(--border-color); }
        #seccion-tierra #initial-message { border-style: dashed; border-color: #D1D5DB; }
        #seccion-tierra #initial-message h3 { color: var(--text-primary); }
        #seccion-tierra #initial-message p { color: var(--text-secondary); }
        #seccion-tierra .info-card { background-color: #EFF6FF; border-color: #BFDBFE; }
        #seccion-tierra .info-card h4, #seccion-tierra .info-card p { color: #1E40AF; }
        #seccion-tierra .info-card .font-bold { color: #1D4ED8; }
        #seccion-tierra .bg-gray-800 { background-color: var(--card-bg); } /* Override dark theme */
        #seccion-tierra .text-white, #seccion-tierra .text-gray-300, #seccion-tierra .text-gray-400 { color: var(--text-secondary); }
        #seccion-tierra .font-bold.text-white { color: var(--text-primary); }
        #seccion-tierra .border-gray-700 { border-color: var(--border-color); }
        #seccion-tierra .bg-gray-700 { background-color: #F9FAFB; }
        #seccion-tierra .border-gray-600 { border-color: #D1D5DB; }
        #seccion-tierra .text-blue-400 { color: var(--primary-color); }

    </style>
</head>
<body>

    <header>
        <h1 class="text-3xl md:text-4xl font-bold">Calculadoras Técnicas Eléctricas</h1>
        <p class="text-md text-gray-300 mt-2">Herramienta unificada para cálculos de Cables, Puesta a Tierra y Cortocircuito.</p>
    </header>

    <nav>
        <a href="#" id="nav-inicio" class="active">Inicio</a>
        <a href="#" id="nav-cables">Cálculo de Cables</a>
        <a href="#" id="nav-tierra">Puesta a Tierra</a>
        <a href="#" id="nav-cortocircuito">Cortocircuito</a>
        <a href="#" id="nav-creditos">Créditos</a>
        <a href="#" id="nav-fullscreen" title="Pantalla Completa">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 3H5a2 2 0 0 0-2 2v3m18 0V5a2 2 0 0 0-2-2h-3m0 18h3a2 2 0 0 0 2-2v-3M3 16v3a2 2 0 0 0 2 2h3"></path></svg>
        </a>
    </nav>

    <main>
        <!-- SECCIÓN DE INICIO -->
        <section id="seccion-inicio">
            <h2 class="text-3xl font-bold mb-4">Bienvenido a la Suite de Cálculo Eléctrico</h2>
            <p class="text-lg text-gray-600">Este proyecto unifica tres herramientas esenciales para el cálculo eléctrico profesional, basadas en la reglamentación argentina (AEA) y normas IRAM.</p>
            <p class="mt-2 text-gray-600">Navega a través de las diferentes calculadoras utilizando el menú superior. Cada herramienta está diseñada para ser intuitiva y proporcionar resultados detallados para tus proyectos.</p>
            <div class="mt-8 p-4 bg-blue-50 border-l-4 border-blue-500 rounded-r-lg">
                <p><strong>INSTITUTO:</strong> INSTITUTO DE FORMACION TECNICA Y PROFESIONAL 13 DE JULIO [EX ENET SEGBA]</p>
            </div>
        </section>

        <!-- ====================================================================== -->
        <!-- CALCULADORA DE SELECCIÓN DE CABLES -->
        <!-- ====================================================================== -->
        <section id="seccion-cables" class="hidden">
            <div class="container mx-auto">
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Calculadora Eléctrica Avanzada</h1>
                    <p class="text-md text-gray-600 mt-2">Basada en Normas IRAM y Reglamentación AEA 90364</p>
                </header>
                <div class="bg-white p-6 rounded-xl shadow-lg mb-8">
                    <h2 class="text-2xl font-bold mb-2 text-blue-700">1. Calculadora de Circuitos</h2>
                    <p class="text-sm text-gray-500 mb-6">Complete todos los datos para realizar un cálculo integral (Icc, Icarga y ΔU) y añadir el circuito a la lista.</p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Datos de la Carga</h3>
                            <div class="space-y-4">
                                <div><label for="potencia" class="block text-sm font-medium">Potencia (kW)</label><input type="number" id="potencia" value="5" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                <div><label for="tension" class="block text-sm font-medium">Tensión (V)</label><select id="tension" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="220">220V</option><option value="380" selected>380V</option></select></div>
                                <div><label for="cosphi" class="block text-sm font-medium">cos φ</label><input type="number" id="cosphi" value="0.9" step="0.01" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Instalación</h3>
                            <div class="space-y-4">
                                <div><label for="longitud" class="block text-sm font-medium">Longitud (m)</label><input type="number" id="longitud" value="50" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                <div><label for="tipoCable" class="block text-sm font-medium">Cable</label><select id="tipoCable" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="IRAM 2178-XLPE-Cu" selected>IRAM 2178 (XLPE/Cu)</option><option value="IRAM 2178-PVC-Cu">IRAM 2178 (PVC/Cu)</option><option value="IRAM 247-PVC-Cu">IRAM 247-3 (PVC/Cu)</option><option value="IRAM 2178-XLPE-Al">IRAM 2178 (XLPE/Al)</option><option value="IRAM 2178-PVC-Al">IRAM 2178 (PVC/Al)</option></select></div>
                                <div><label for="tipoTendido" class="block text-sm font-medium">Tendido</label><select id="tipoTendido" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="B1">B1/B2 (Cañería)</option><option value="C" selected>C (Bandeja no perf.)</option><option value="E">E (Bandeja perf.)</option><option value="F">F (Trébol en bandeja)</option></select></div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Factores y Falla</h3>
                                <div class="space-y-4">
                                    <div><label for="temperatura" class="block text-sm font-medium">Temp. (°C)</label><input type="number" id="temperatura" value="40" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                    <div><label for="agrupamiento" class="block text-sm font-medium">Agrup.</label><input type="number" id="agrupamiento" value="1" min="1" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                    <div><label for="icc" class="block text-sm font-medium">Icc a Soportar (kA)</label><input type="number" id="icc" value="10" step="0.1" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                </div>
                        </div>
                            <div>
                            <h3 class="text-lg font-semibold mb-2 border-b pb-1 text-gray-700">Proyecto</h3>
                            <div class="space-y-4">
                                <div><label for="tiempoActuacion" class="block text-sm font-medium">T. Prot. (s)</label><input type="number" id="tiempoActuacion" value="0.1" step="0.01" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                                <div><label for="caidaTensionAdm" class="block text-sm font-medium">ΔU Adm (%)</label><select id="caidaTensionAdm" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"><option value="3">3%</option><option value="5" selected>5%</option><option value="15">15%</option></select></div>
                                <div><label for="nombreCircuito" class="block text-sm font-medium">Nombre</label><input type="text" id="nombreCircuito" placeholder="Ej: Bomba Piscina" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-end gap-4 border-t pt-4">
                        <button id="add-circuit" class="btn btn-primary">Calcular y Añadir</button>
                    </div>
                        <div id="resultado-cable" class="mt-6 hidden"></div>
                        <div id="manual-analysis-section" class="mt-6 hidden">
                            <h3 class="text-lg font-semibold mb-2 text-gray-800 border-t pt-4">Análisis Manual de Secciones</h3>
                                <div class="flex items-end gap-4">
                                    <div class="flex-grow">
                                        <label for="seccion-manual-select" class="block text-sm font-medium">Seleccione una sección para probar</label>
                                        <select id="seccion-manual-select" class="mt-1 block w-full bg-gray-50 border-gray-300 rounded-md shadow-sm py-2 px-3"></select>
                                    </div>
                                    <button id="probar-seccion-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white">Probar Sección</button>
                                </div>
                                <div id="resultado-manual" class="mt-4"></div>
                        </div>
                </div>
                
                <div class="mb-8">
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-4">
                        <h2 class="text-2xl font-bold text-gray-800">2. Lista de Circuitos del Proyecto</h2>
                        <div class="flex gap-2">
                            <button id="export-csv" class="btn bg-green-600 hover:bg-green-700 text-white text-sm">Exportar a CSV</button>
                            <button id="clear-list" class="btn btn-danger text-sm">Limpiar Lista</button>
                        </div>
                    </div>
                    <div id="lista-circuitos" class="space-y-4">
                            <p id="empty-list-message" class="text-center text-gray-500 py-8 bg-gray-50 rounded-xl shadow-sm">Aún no se han añadido circuitos.</p>
                    </div>
                </div>

                <div>
                    <h2 class="text-2xl font-bold text-gray-800 mb-4">3. Anexos y Tablas de Referencia</h2>
                    <div class="bg-white p-6 rounded-xl shadow-lg">
                        <div class="border-b border-gray-200">
                            <nav class="-mb-px flex space-x-6 overflow-x-auto" id="tab-container-cables">
                                <button data-tab="tab-formulas" class="tab-button-cables active py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-500 whitespace-nowrap">Fórmulas</button>
                                <button data-tab="tab-log" class="tab-button-cables py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-500 whitespace-nowrap">Memoria de Cálculo</button>
                                <button data-tab="tab-k1" class="tab-button-cables py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-500 whitespace-nowrap">Tabla k1</button>
                                <button data-tab="tab-k2" class="tab-button-cables py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-500 whitespace-nowrap">Tabla k2</button>
                                <button data-tab="tab-kicc" class="tab-button-cables py-4 px-1 border-b-2 border-transparent text-gray-500 hover:text-blue-600 hover:border-blue-500 whitespace-nowrap">Tabla k (Icc)</button>
                            </nav>
                        </div>
                        <div id="tab-content-cables" class="pt-6"></div>
                    </div>
                </div>
            </div>
            
            <template id="circuit-card-template">
                <div class="bg-white p-4 rounded-lg shadow-md border-l-4">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-gray-800"></h4>
                            <p class="text-sm text-gray-500"></p>
                        </div>
                        <button class="remove-card text-gray-400 hover:text-red-500 text-2xl leading-none">&times;</button>
                    </div>
                    <div class="mt-2 pt-2 border-t text-sm grid grid-cols-2 md:grid-cols-4 gap-2">
                        <div><span class="font-semibold">Sección:</span> <span class="data-seccion"></span></div>
                        <div><span class="font-semibold">I<sub>carga</sub>:</span> <span class="data-icarga"></span></div>
                        <div><span class="font-semibold">I<sub>adm</sub>:</span> <span class="data-iadm"></span></div>
                        <div><span class="font-semibold">ΔU:</span> <span class="data-delta-u"></span></div>
                    </div>
                </div>
            </template>
        </section>

        <!-- ====================================================================== -->
        <!-- CALCULADORA DE PUESTA A TIERRA -->
        <!-- ====================================================================== -->
        <section id="seccion-tierra" class="hidden">
            <div class="container mx-auto relative">
                <header class="text-center mb-8">
                    <h1 class="text-3xl md:text-4xl font-bold">Planificador de Puesta a Tierra (Esquema TT)</h1>
                    <p class="text-gray-600 mt-2">Diseño de proyecto según reglamentación AEA 90364.</p>
                </header>
        
                <div class="grid grid-cols-1 md:grid-cols-12 gap-8">
        
                    <!-- Columna de Parámetros -->
                    <div class="md:col-span-4 p-6 rounded-xl">
                        <div>
                            <label for="mode_selector_tierra" class="block text-sm font-medium mb-2">Modo de Calculadora</label>
                            <select id="mode_selector_tierra" class="input-group w-full">
                                <option value="domiciliaria">Verificación Domiciliaria</option>
                                <option value="proyecto">Proyecto Completo (Multi-Sector)</option>
                            </select>
                        </div>
                        
                        <hr class="border-gray-200 my-6">

                        <!-- Parámetros Comunes -->
                        <div class="space-y-6">
                            <h2 class="text-2xl font-semibold -mt-2">1. Parámetros Generales</h2>
                            <div>
                                <label class="block text-sm font-medium mb-2">
                                    Condiciones / Tensión Límite ($U_L$)
                                    <span class="tooltip-container">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">Tensión máxima a la que puede quedar sometida una persona indefinidamente. 24V para locales húmedos/exteriores o sin supervisión. 50V para locales secos con personal instruido.</span>
                                    </span>
                                </label>
                                <select id="ul_condition" class="w-full input-group">
                                    <option value="24" selected>Común / Sin supervisión (UL = 24V)</option>
                                    <option value="50">Seco / Personal capacitado (UL = 50V)</option>
                                </select>
                            </div>
                            <div>
                                <label for="tipo_suelo" class="block text-sm font-medium mb-2">
                                    Resistividad Base del Terreno (ρ)
                                        <span class="tooltip-container">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">Oposición del suelo al paso de corriente. Varía según el tipo de suelo. Seleccione un valor de tabla o ingrese uno medido.</span>
                                    </span>
                                </label>
                                <select id="tipo_suelo" class="w-full input-group mb-2">
                                    <option value="10" selected>Arcillas (10 Ω·m)</option>
                                    <option value="5">Aluvial (5 Ω·m)</option>
                                    <option value="20">Greda (20 Ω·m)</option>
                                    <option value="50">T. calcárea (50 Ω·m)</option>
                                    <option value="100">Arenisca (100 Ω·m)</option>
                                    <option value="custom">Ingresar valor manual...</option>
                                </select>
                                <input type="number" id="resistividad_manual" placeholder="Ej: 80" class="w-full input-group hidden">
                            </div>
                                <div>
                                <label for="humedad_terreno" class="block text-sm font-medium mb-2">
                                    Condiciones de Humedad del Terreno
                                        <span class="tooltip-container">
                                        <span class="tooltip-icon">?</span>
                                        <span class="tooltip-text">Ajusta la resistividad base. La humedad reduce la resistividad. 'Seco' aumenta el valor, 'Húmedo' lo reduce.</span>
                                    </span>
                                </label>
                                <select id="humedad_terreno" class="w-full input-group">
                                    <option value="1.5">Seco (aumenta resistividad)</option>
                                    <option value="1.0" selected>Normal (valor base)</option>
                                    <option value="0.7">Húmedo (reduce resistividad)</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Modo Domiciliaria -->
                        <div id="mode_domiciliaria" class="mode-section mt-8 space-y-6">
                            <h2 class="text-2xl font-semibold border-b border-gray-200 pb-3">2. Puesta a Tierra a Verificar</h2>
                            <div class="space-y-3">
                                    <label class="text-sm font-medium">Sensibilidad Diferencial (IΔn)</label>
                                    <select id="domiciliaria_rcd" class="w-full input-group">
                                        <option value="30" selected>30 mA</option><option value="100">100 mA</option><option value="300">300 mA</option>
                                        <option value="500">500 mA</option><option value="1000">1 A</option>
                                    </select>
                                    <div class="mt-2">
                                        <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                            <input type="checkbox" id="domiciliaria_manual_obj_check" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                                            <span>Usar objetivo manual de resistencia</span>
                                        </label>
                                        <input type="number" id="domiciliaria_manual_obj_input" placeholder="Ej: 5 Ω" class="w-full input-group mt-2 hidden">
                                    </div>
                            </div>
                            <div>
                                <label class="text-sm font-medium">Tipo de Electrodo</label>
                                <select id="domiciliaria_electrode_type" class="w-full input-group mt-2">
                                    <option value="jabalina_v" selected>Jabalina Vertical</option>
                                    <option value="jabalina_h">Jabalina Horizontal</option>
                                    <option value="placa">Placa</option>
                                    <option value="malla">Malla</option>
                                </select>
                            </div>
                            <!-- Parámetros Jabalina Vertical -->
                            <div id="domiciliaria_jabalina_v_params" class="electrode-params space-y-2">
                                    <label class="text-sm font-medium">Dimensiones Jabalina</label>
                                    <div class="grid grid-cols-2 gap-2">
                                        <select id="domiciliaria_l" class="w-full input-group"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                                        <select id="domiciliaria_d" class="w-full input-group"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                                    </div>
                            </div>
                            <!-- Parámetros Jabalina Horizontal -->
                            <div id="domiciliaria_jabalina_h_params" class="electrode-params space-y-2">
                                <label class="text-sm font-medium">Dimensiones Conductor Horizontal (m)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="domiciliaria_h_l" value="10" class="w-full input-group" placeholder="Longitud">
                                    <input type="number" id="domiciliaria_h_p" value="0.5" class="w-full input-group" placeholder="Profundidad">
                                </div>
                            </div>
                            <!-- Parámetros Placa -->
                            <div id="domiciliaria_placa_params" class="electrode-params space-y-2">
                                <label class="text-sm font-medium">Dimensiones Placa (m)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="domiciliaria_placa_a" value="1" class="w-full input-group" placeholder="Lado A">
                                    <input type="number" id="domiciliaria_placa_b" value="1" class="w-full input-group" placeholder="Lado B">
                                </div>
                            </div>
                                <!-- Parámetros Malla -->
                            <div id="domiciliaria_malla_params" class="electrode-params space-y-2">
                                <label class="text-sm font-medium">Dimensiones Malla (m)</label>
                                <div class="grid grid-cols-2 gap-2">
                                    <input type="number" id="domiciliaria_malla_l" value="5" class="w-full input-group" placeholder="Longitud Total Conductor">
                                    <input type="number" id="domiciliaria_malla_A" value="4" class="w-full input-group" placeholder="Área (m²)">
                                </div>
                            </div>
                        </div>

                        <!-- Modo Proyecto -->
                        <div id="mode_proyecto" class="mode-section mt-8">
                                <div class="space-y-6">
                                    <h2 class="text-2xl font-semibold border-b border-gray-200 pb-3">2. Puesta a Tierra de Servicio (RB)</h2>
                                    <p class="text-xs -mt-2">Sistema para el neutro de la acometida. Objetivo ≤ 1.0 Ω por defecto.</p>
                                    <div>
                                        <label class="text-sm font-medium">Jabalina para Servicio</label>
                                        <div class="grid grid-cols-2 gap-2 mt-2">
                                            <select id="proyecto_service_l" class="w-full input-group"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                                            <select id="proyecto_service_d" class="w-full input-group"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                            <input type="checkbox" id="proyecto_service_manual_check" class="form-checkbox h-4 w-4 text-blue-600 rounded">
                                            <span>Usar objetivo manual</span>
                                        </label>
                                        <input type="number" id="proyecto_service_manual_input" value="1" placeholder="Ej: 0.8 Ω" class="w-full input-group mt-2 hidden">
                                    </div>
                                </div>
                            <h2 class="text-2xl font-semibold border-b border-gray-200 pb-3 mb-4 mt-8">3. Sectores de Protección (RA)</h2>
                            <div id="sectores-container" class="space-y-4"></div>
                            <button id="addSectorBtn" class="mt-4 w-full flex items-center justify-center py-2 px-4 border border-dashed border-gray-400 text-sm font-medium rounded-lg text-gray-500 hover:text-gray-700 hover:border-gray-400 transition">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd"></path></svg>
                                Añadir Sector
                            </button>
                        </div>

                        <button id="calcularBtn" class="w-full btn btn-primary mt-8"></button>
                    </div>

                    <!-- Columna de Resultados -->
                    <div class="md:col-span-8">
                        <div id="results-container" class="bg-white p-6 rounded-xl shadow-lg min-h-full" style="display: none;"></div>
                        <div id="initial-message" class="flex items-center justify-center bg-white p-6 rounded-xl border-2 border-dashed border-gray-300 min-h-full">
                            <div class="text-center">
                                <svg class="mx-auto h-12 w-12 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                <h3 class="mt-2 text-lg font-medium">Listo para Planificar</h3>
                                <p class="mt-1 text-sm text-gray-500">Seleccione el modo, complete los parámetros y presione "Calcular".</p>
                            </div>
                        </div>
                        <div id="loader-container" class="hidden items-center justify-center bg-white p-6 rounded-xl"><div class="loader"></div></div>
                    </div>
                </div>
            </div>
            <textarea id="export-content" class="hidden"></textarea>
        </section>

        <!-- ====================================================================== -->
        <!-- CALCULADORA DE CORTOCIRCUITO -->
        <!-- ====================================================================== -->
        <section id="seccion-cortocircuito" class="hidden">
            <div id="diagramModal">
                <span id="closeDiagramModal">&times;</span>
                <div id="diagramModalContent"></div>
            </div>
        
            <div class="container mx-auto max-w-screen-2xl">
                <header class="text-center mb-8 relative">
                    <h1 class="text-3xl md:text-4xl font-bold text-gray-900">Calculadora de Cortocircuito Profesional</h1>
                    <p class="text-md text-gray-600 mt-2">Análisis con Diagrama Unifilar Dinámico</p>
                </header>
        
                <div class="mb-12">
                    <h2 class="text-2xl font-bold text-center mb-6 text-gray-800 border-b pb-3">Análisis de Impedancia de Falla</h2>
                    <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                        
                        <div class="bg-white p-6 rounded-xl shadow-md lg:col-span-2">
                            <form id="shortCircuitForm">
                                <div class="section-divider">
                                    <h3 class="text-xl font-semibold mb-4 text-gray-800">1. Red de Distribución (MT)</h3>
                                    <div class="input-group"><label for="sccRed">Scc Red [MVA]</label><input type="number" id="sccRed" value="250" min="1" class="data-input"></div>
                                    <div class="input-group"><label for="tensionRed">Tensión Red [kV]</label><input type="number" id="tensionRed" value="13.2" min="1" class="data-input"></div>
                                </div>

                                <div id="transformerFeedersContainer"></div>
                                
                                <div class="mt-6 flex space-x-4">
                                    <button type="button" id="addFeederBtn" class="btn bg-purple-600 hover:bg-purple-700 text-white w-full">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 5a1 1 0 011 1v3h3a1 1 0 110 2h-3v3a1 1 0 11-2 0v-3H6a1 1 0 110-2h3V6a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                        Agregar Alimentador
                                    </button>
                                        <button type="button" id="resetButtonSC" class="btn btn-danger">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M4 2a1 1 0 011 1v2.101a7.002 7.002 0 0111.601 2.566 1 1 0 11-1.885.666A5.002 5.002 0 005.999 7H9a1 1 0 110 2H4a1 1 0 01-1-1V3a1 1 0 011-1zm.008 9.057a1 1 0 011.276.61A5.002 5.002 0 0014.001 13H11a1 1 0 110-2h5a1 1 0 011 1v5a1 1 0 11-2 0v-2.101a7.002 7.002 0 01-11.601-2.566 1 1 0 01.61-1.276z" clip-rule="evenodd" /></svg>
                                        Reiniciar
                                    </button>
                                </div>
                            </form>
                        </div>

                        <div class="space-y-8 lg:col-span-3">
                            <div id="diagramCard" class="bg-white p-6 rounded-xl shadow-md">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="text-xl font-semibold text-gray-800">Diagrama Unifilar</h3>
                                    <button id="fullscreenDiagramBtn" class="btn btn-sm bg-gray-200 hover:bg-gray-300 text-gray-700" title="Ver en Pantalla Completa">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8V4m0 0h4M4 4l5 5m11-1V4m0 0h-4m4 0l-5 5M4 16v4m0 0h4m-4 0l5-5m11 1v4m0 0h-4m4 0l-5-5" /></svg>
                                    </button>
                                </div>
                                <div id="diagramContainerWrapper" class="p-4 border rounded-lg bg-gray-50 min-h-[400px] overflow-x-auto">
                                    <div id="diagramContainer"></div>
                                </div>
                            </div>
                            <div id="resultsContainerSC" class="bg-white p-6 rounded-xl shadow-md">
                                <div class="flex justify-between items-center"><h3 class="text-xl font-semibold mb-4 text-gray-800">Resultados</h3>
                                    <div class="flex gap-2">
                                            <button id="exportWordBtn" class="btn bg-blue-600 hover:bg-blue-700 text-white text-sm py-2 px-3">Word</button>
                                            <button id="exportSCBtn" class="btn bg-green-600 hover:bg-green-700 text-white text-sm py-2 px-3">CSV</button>
                                    </div>
                                </div>
                                <div id="resultsPlaceholderSC" class="text-center text-gray-500 py-10"><svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-12 w-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V7a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg><p class="mt-4">Agregue un alimentador para comenzar.</p></div>
                                <div id="resultsContentSC"></div>
                            </div>
                        </div>
                    </div>
                </div>
        
                <div id="anexo" class="anexo-box">
                    <h3>Anexo Técnico</h3>
                    <div>
                        <h4>Fundamentos Normativos (IRAM / AEA)</h4>
                        <p>El cálculo de corrientes de cortocircuito es un requisito fundamental de la <strong>Reglamentación para la Ejecución de Instalaciones Eléctricas en Inmuebles AEA 90364</strong>. El objetivo es asegurar que todos los componentes de la instalación (cables, interruptores, tableros) puedan soportar los esfuerzos térmicos y dinámicos producidos por una falla. Esta calculadora aplica el <strong>método de las impedancias</strong>, que consiste en sumar todas las impedancias (Red, transformadores, cables) desde la fuente hasta el punto de falla para determinar la corriente de cortocircuito máxima (Icc). La verificación del cable se realiza según la fórmula de solicitación térmica adiabática (I²t), especificada en la norma <strong>IRAM 2178</strong>, asegurando que la energía que el cable puede soportar ($K^2S^2$) sea mayor a la energía que deja pasar la protección ($I_{cc}^2t$).</p>
                    </div>
                        <div>
                        <h4>Aporte de Motores al Cortocircuito</h4>
                        <p>Durante un cortocircuito, la tensión del sistema cae bruscamente. En ese instante, los motores de inducción, por su inercia y el campo magnético remanente en su rotor, dejan de consumir energía y comienzan a funcionar como generadores, aportando corriente a la falla. Este aporte es de corta duración (típicamente unos pocos ciclos) pero significativo. Según la bibliografía técnica, se estima que un motor puede aportar una corriente de entre <strong>4 a 6 veces su corriente nominal (In)</strong>. Esta calculadora utiliza un factor conservador de 5. Es crucial considerar este aporte, ya que la corriente total que debe interrumpir una protección en un tablero no es solo la que proviene de la red, sino la suma de la corriente de la red más la de todos los motores aguas abajo del punto de falla.</p>
                    </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-6">
                            <div> <h4 class="text-lg font-semibold mb-2 text-indigo-700">Factor de Impulso χ (Kappa)</h4> <div class="overflow-x-auto"> <table id="kappaTable"></table> </div> </div>
                            <div> <h4 class="text-lg font-semibold mb-2 text-indigo-700">Valores Típicos para Transformadores</h4> <div class="overflow-x-auto"> <table id="trafoTable"></table> </div> </div>
                    </div>
                    <div class="mt-8">
                        <h4 class="text-lg font-semibold mb-2 text-indigo-700">Memoria de Cálculo (Paso a Paso)</h4>
                        <div id="calculationLogContainer" class="bg-white p-4 rounded-lg shadow-inner max-h-96 overflow-y-auto">
                            <p class="text-gray-500 p-4 text-center">El detalle del cálculo aparecerá aquí.</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- SECCIÓN DE CRÉDITOS -->
        <section id="seccion-creditos" class="hidden">
            <h2 class="text-3xl font-bold mb-4">Créditos</h2>
            <div class="space-y-4 text-gray-700">
                <p><strong>Creado por:</strong> Jesus Uriel Castellanos</p>
                <p><strong>Rol:</strong> Alumno de 6to ATT - CICLO LECTIVO 2025</p>
                <p><strong>Instituto:</strong> INSTITUTO DE FORMACION TECNICA Y PROFESIONAL 13 DE JULIO [EX ENET SEGBA]</p>
                <hr class="my-6">
                <h3 class="text-2xl font-semibold">Agradecimientos Especiales</h3>
                <ul class="list-disc list-inside space-y-2">
                    <li>Al Instituto, por la formación y el espacio brindado.</li>
                    <li>Al Ingeniero Gabriel Massa, condecorado por Ecopyme, por su invaluable conocimiento y guía.</li>
                    <li>A mi Papá.</li>
                    <li>A mi Mamá.</li>
                    <li>A mi Perro.</li>
                    <li>A mi Hermana.</li>
                    <li>A mi Abuela.</li>
                    <li>A mi Abuelo.</li>
                    <li>A mi Tío.</li>
                    <li>A mi Sobrino.</li>
                    <li>A mi Gato.</li>
                </ul>
            </div>
        </section>
    </main>

    <footer>
        <p>&copy; 2025 Jesus Uriel Castellanos - Todos los derechos reservados.</p>
    </footer>

    <!-- ====================================================================== -->
    <!-- SCRIPT UNIFICADO -->
    <!-- ====================================================================== -->
    <script>
    document.addEventListener('DOMContentLoaded', function() {

        // --- LÓGICA DE NAVEGACIÓN PRINCIPAL Y PANTALLA COMPLETA ---
        const navLinks = document.querySelectorAll('nav a');
        const sections = document.querySelectorAll('main > section');
        const fullscreenBtn = document.getElementById('nav-fullscreen');

        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    alert(`Error al intentar activar el modo de pantalla completa: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                }
            }
        }

        fullscreenBtn.addEventListener('click', (e) => {
            e.preventDefault();
            toggleFullScreen();
        });

        function showSection(sectionId) {
            sections.forEach(section => {
                section.classList.toggle('hidden', section.id !== sectionId);
            });
            if (sectionId === 'seccion-tierra' && window.MathJax) {
                setTimeout(() => {
                    MathJax.typesetPromise();
                }, 10);
            }
        }

        navLinks.forEach(link => {
            if (link.id !== 'nav-fullscreen') { // No aplicar a pantalla completa
                link.addEventListener('click', function(event) {
                    event.preventDefault();
                    navLinks.forEach(nav => nav.classList.remove('active'));
                    this.classList.add('active');
                    const sectionId = 'seccion-' + this.id.split('-')[1];
                    showSection(sectionId);
                });
            }
        });

        showSection('seccion-inicio');


        // ======================================================================
        // --- INICIO: CÓDIGO DE LA CALCULADORA DE SELECCIÓN DE CABLES ---
        // ======================================================================
        (() => {
            const cableData = {'IRAM 2178-XLPE-Cu':{aislacion:'XLPE',material:'Cu',k_icc:143,resistencias:[{s:1.5,r:16.96,x:.115},{s:2.5,r:10.18,x:.115},{s:4,r:6.31,x:.115},{s:6,r:4.21,x:.107},{s:10,r:2.44,x:.107},{s:16,r:1.54,x:.1},{s:25,r:.995,x:.1},{s:35,r:.707,x:.095},{s:50,r:.493,x:.091},{s:70,r:.348,x:.086},{s:95,r:.264,x:.083},{s:120,r:.207,x:.081},{s:150,r:.167,x:.079},{s:185,r:.138,x:.079},{s:240,r:.106,x:.076},{s:300,r:.086,x:.076},{s:400,r:.068,x:.075},{s:500,r:.055,x:.075},{s:630,r:.045,x:.074}],corrientes:{B1:{mono:[{s:1.5,i:20},{s:2.5,i:27},{s:4,i:36},{s:6,i:46},{s:10,i:63},{s:16,i:83},{s:25,i:108},{s:35,i:133},{s:50,i:159},{s:70,i:201},{s:95,i:241},{s:120,i:278},{s:150,i:304},{s:185,i:349},{s:240,i:418},{s:300,i:484,x:.083}],tri:[{s:1.5,i:18},{s:2.5,i:24},{s:4,i:32},{s:6,i:40},{s:10,i:55},{s:16,i:73},{s:25,i:96},{s:35,i:116},{s:50,i:140},{s:70,i:177},{s:95,i:212},{s:120,i:244},{s:150,i:273},{s:185,i:309},{s:240,i:362},{s:300,i:414}]},C:{mono:[{s:1.5,i:22},{s:2.5,i:30},{s:4,i:41},{s:6,i:53},{s:10,i:71},{s:16,i:97},{s:25,i:126},{s:35,i:156},{s:50,i:190},{s:70,i:245},{s:95,i:298},{s:120,i:348},{s:150,i:401},{s:185,i:460},{s:240,i:545},{s:300,i:631},{s:400,i:749},{s:500,i:861}],tri:[{s:1.5,i:20},{s:2.5,i:27},{s:4,i:36},{s:6,i:47},{s:10,i:65},{s:16,i:87},{s:25,i:108},{s:35,i:134},{s:50,i:163},{s:70,i:208},{s:95,i:253},{s:120,i:293},{s:150,i:338},{s:185,i:386},{s:240,i:455},{s:300,i:524},{s:400,i:615},{s:500,i:700}]},E:{mono:[{s:1.5,i:24},{s:2.5,i:33},{s:4,i:45},{s:6,i:57},{s:10,i:78},{s:16,i:105},{s:25,i:136},{s:35,i:168},{s:50,i:205},{s:70,i:263},{s:95,i:320},{s:120,i:373},{s:150,i:430},{s:185,i:493},{s:240,i:583},{s:300,i:674},{s:400,i:855},{s:500,i:986}],tri:[{s:1.5,i:21},{s:2.5,i:29},{s:4,i:38},{s:6,i:49},{s:10,i:68},{s:16,i:91},{s:25,i:116},{s:35,i:144},{s:50,i:175},{s:70,i:224},{s:95,i:271},{s:120,i:315},{s:150,i:363},{s:185,i:415},{s:240,i:490},{s:300,i:565},{s:400,i:749},{s:500,i:861}]}}},
            'IRAM 2178-PVC-Cu':{aislacion:'PVC',material:'Cu',k_icc:115,resistencias:[{s:1.5,r:15.91,x:.115},{s:2.5,r:9.55,x:.115},{s:4,r:5.92,x:.115},{s:6,r:3.95,x:.107},{s:10,r:2.29,x:.107},{s:16,r:1.48,x:.1},{s:25,r:.934,x:.1},{s:35,r:.663,x:.095},{s:50,r:.463,x:.091},{s:70,r:.326,x:.086},{s:95,r:.248,x:.083},{s:120,r:.195,x:.081},{s:150,r:.157,x:.079},{s:185,r:.13,x:.079},{s:240,r:.1,x:.076},{s:300,r:0.082,x:0.076},{s:400,r:.068,x:.075},{s:500,r:.055,x:.075},{s:630,r:.045,x:.074}],corrientes:{B1:{mono:[{s:1.5,i:14},{s:2.5,i:20},{s:4,i:26},{s:6,i:33},{s:10,i:45},{s:16,i:60},{s:25,i:78},{s:35,i:97},{s:50,i:116},{s:70,i:146},{s:95,i:175},{s:120,i:202},{s:150,i:224},{s:185,i:256},{s:240,i:299},{s:300,i:343}],tri:[{s:1.5,i:13},{s:2.5,i:17},{s:4,i:23},{s:6,i:30},{s:10,i:40},{s:16,i:54},{s:25,i:70},{s:35,i:86},{s:50,i:103},{s:70,i:130},{s:95,i:156},{s:120,i:179},{s:150,i:196},{s:185,i:222},{s:240,i:258},{s:300,i:295}]},C:{mono:[{s:1.5,i:17},{s:2.5,i:23},{s:4,i:31},{s:6,i:40},{s:10,i:55},{s:16,i:74},{s:25,i:97},{s:35,i:120},{s:50,i:146},{s:70,i:185},{s:95,i:224},{s:120,i:260},{s:150,i:299},{s:185,i:341},{s:240,i:401},{s:300,i:461}],tri:[{s:1.5,i:15},{s:2.5,i:21},{s:4,i:28},{s:6,i:36},{s:10,i:50},{s:16,i:66},{s:25,i:84},{s:35,i:104},{s:50,i:125},{s:70,i:160},{s:95,i:194},{s:120,i:225},{s:150,i:260},{s:185,i:297},{s:240,i:351},{s:300,i:404}]},E:{mono:[{s:1.5,i:19},{s:2.5,i:26},{s:4,i:35},{s:6,i:44},{s:10,i:61},{s:16,i:82},{s:25,i:104},{s:35,i:129},{s:50,i:157},{s:70,i:202},{s:95,i:245},{s:120,i:285},{s:150,i:330},{s:185,i:378},{s:240,i:447},{s:300,i:516}],tri:[{s:1.5,i:16},{s:2.5,i:22},{s:4,i:30},{s:6,i:37},{s:10,i:52},{s:16,i:70},{s:25,i:88},{s:35,i:110},{s:50,i:133},{s:70,i:171},{s:95,i:207},{s:120,i:240},{s:150,i:278},{s:185,i:317},{s:240,i:374},{s:300,i:432}]},F:{tri:[{s:25,i:96},{s:35,i:119},{s:50,i:145},{s:70,i:188},{s:95,i:230},{s:120,i:268},{s:150,i:310},{s:185,i:356},{s:240,i:422},{s:300,i:488},{s:400,i:571},{s:500,i:652},{s:630,i:744}]}}},
            'IRAM 247-PVC-Cu':{aislacion:'PVC',material:'Cu',k_icc:115,resistencias:[{s:1.5,r:15.91,x:.115},{s:2.5,r:9.55,x:.115},{s:4,r:5.92,x:.115},{s:6,r:3.95,x:.107},{s:10,r:2.29,x:.107},{s:16,r:1.48,x:.1},{s:25,r:.934,x:.1},{s:35,r:.663,x:.095},{s:50,r:.463,x:.091}],corrientes:{B1:{mono:[{s:1.5,i:15},{s:2.5,i:21},{s:4,i:28},{s:6,i:36},{s:10,i:50},{s:16,i:66},{s:25,i:88},{s:35,i:108},{s:50,i:131}],tri:[{s:1.5,i:14},{s:2.5,i:18},{s:4,i:25},{s:6,i:32},{s:10,i:44},{s:16,i:59},{s:25,i:77},{s:35,i:96},{s:50,i:117}]},C:null,E:null,F:null}},
            'IRAM 2178-XLPE-Al':{aislacion:'XLPE',material:'Al',k_icc:94,resistencias:[{s:16,r:2.392,x:.1},{s:25,r:1.513,x:.1},{s:35,r:1.093,x:.095},{s:50,r:.8,x:.091},{s:70,r:.558,x:.086},{s:95,r:.403,x:.083},{s:120,r:.321,x:.081},{s:150,r:.262,x:.079},{s:185,r:.209,x:.079},{s:240,r:.161,x:.076},{s:300,r:.128,x:.076},{s:400,r:.102,x:.075},{s:500,r:.084,x:.075},{s:630,r:0.07,x:0.074}],corrientes:{B1:{mono:[{s:16,i:66},{s:25,i:86},{s:35,i:105},{s:50,i:126},{s:70,i:159},{s:95,i:191},{s:120,i:220},{s:150,i:238},{s:185,i:273},{s:240,i:326},{s:300,i:378}],tri:[{s:16,i:58},{s:25,i:76},{s:35,i:94},{s:50,i:113},{s:70,i:142},{s:95,i:171},{s:120,i:197},{s:150,i:218},{s:185,i:248},{s:240,i:289},{s:300,i:331}]},C:{mono:[{s:16,i:76},{s:25,i:92},{s:35,i:115},{s:50,i:140},{s:70,i:180},{s:95,i:219},{s:120,i:255},{s:150,i:295},{s:185,i:338},{s:240,i:399},{s:300,i:462},{s:400,i:584},{s:500,i:674}],tri:[{s:16,i:69},{s:25,i:82},{s:35,i:102},{s:50,i:124},{s:70,i:158},{s:95,i:192},{s:120,i:223},{s:150,i:258},{s:185,i:294},{s:240,i:348},{s:300,i:400},{s:400,i:480},{s:500,i:557}]},E:{mono:[{s:16,i:83},{s:25,i:98},{s:35,i:123},{s:50,i:149},{s:70,i:192},{s:95,i:234},{s:120,i:273},{s:150,i:315},{s:185,i:361},{s:240,i:428},{s:300,i:494},{s:400,i:673},{s:500,i:779}],tri:[{s:16,i:70},{s:25,i:88},{s:35,i:109},{s:50,i:133},{s:70,i:170},{s:95,i:207},{s:120,i:239},{s:150,i:277},{s:185,i:316},{s:240,i:372},{s:300,i:429},{s:400,i:531},{s:500,i:701}]}}},
            'IRAM 2178-PVC-Al':{aislacion:'PVC',material:'Al',k_icc:76,resistencias:[{s:16,r:2.392,x:.1},{s:25,r:1.513,x:.1},{s:35,r:1.093,x:.095},{s:50,r:.8,x:.091},{s:70,r:.558,x:.086},{s:95,r:.403,x:.083},{s:120,r:.321,x:.081},{s:150,r:.262,x:.079},{s:185,r:.209,x:.079},{s:240,r:.161,x:.076},{s:300,r:.128,x:.076},{s:400,r:.102,x:.075},{s:500,r:.084,x:.075},{s:630,r:0.07,x:0.074}],corrientes:{B1:{mono:[{s:16,i:47},{s:25,i:62},{s:35,i:75},{s:50,i:90},{s:70,i:114},{s:95,i:137},{s:120,i:157},{s:150,i:175},{s:185,i:200},{s:240,i:234},{s:300,i:268}],tri:[{s:16,i:42},{s:25,i:54},{s:35,i:67},{s:50,i:80},{s:70,i:101},{s:95,i:121},{s:120,i:139},{s:150,i:153},{s:185,i:173},{s:240,i:202},{s:300,i:231}]},C:{mono:[{s:16,i:57},{s:25,i:72},{s:35,i:90},{s:50,i:109},{s:70,i:139},{s:95,i:170},{s:120,i:197},{s:150,i:227},{s:185,i:259},{s:240,i:306},{s:300,i:353},{s:400,i:458},{s:500,i:531}],tri:[{s:16,i:51},{s:25,i:64},{s:35,i:78},{s:50,i:96},{s:70,i:122},{s:95,i:148},{s:120,i:171},{s:150,i:197},{s:185,i:225},{s:240,i:265},{s:300,i:305},{s:400,i:378},{s:500,i:432}]},E:{mono:[{s:2.5,i:20},{s:4,i:27},{s:6,i:34},{s:10,i:47},{s:16,i:64},{s:25,i:77},{s:35,i:97},{s:50,i:117},{s:70,i:151},{s:95,i:183},{s:120,i:212},{s:150,i:245},{s:185,i:280},{s:240,i:331},{s:300,i:382}],tri:[{s:2.5,i:17},{s:4,i:23},{s:6,i:29},{s:10,i:40},{s:16,i:53},{s:25,i:68},{s:35,i:84},{s:50,i:102},{s:70,i:131},{s:95,i:159},{s:120,i:184},{s:150,i:213},{s:185,i:244},{s:240,i:287},{s:300,i:331}]},F:{tri:[{s:25,i:73},{s:35,i:91},{s:50,i:111},{s:70,i:144},{s:95,i:177},{s:120,i:206},{s:150,i:238},{s:185,i:274},{s:240,i:326},{s:300,i:378},{s:400,i:458},{s:500,i:531},{s:630,i:619}]}}},
            };
            const k1_temp={PVC:[{t:10,f:1.4},{t:15,f:1.34},{t:20,f:1.29},{t:25,f:1.22},{t:30,f:1.15},{t:35,f:1.08},{t:40,f:1},{t:45,f:.91},{t:50,f:.82},{t:55,f:.7},{t:60,f:.57}],XLPE:[{t:10,f:1.26},{t:15,f:1.23},{t:20,f:1.19},{t:25,f:1.14},{t:30,f:1.1},{t:35,f:1.05},{t:40,f:1},{t:45,f:.96},{t:50,f:.9},{s:55,f:.84},{t:60,f:.78},{t:65,f:.71},{t:70,f:.64},{t:75,f:.55},{t:80,f:.45}]};
            const k2_agrup=[{n:1,f:1},{n:2,f:.8},{n:3,f:.7},{n:4,f:.65},{n:5,f:.6},{n:6,f:.57},{n:7,f:.54},{n:8,f:.52},{n:9,f:.5}];
            const annexContent={"tab-formulas":`<h4 class="text-lg font-semibold mb-4">Fórmulas de Cálculo Principales</h4><div class="space-y-6"><div><h5 class="font-semibold text-md">1. Corriente de Carga (I<sub>carga</sub>)</h5><p class="text-sm text-gray-600 mt-1">Para circuitos trifásicos:</p><code class="block bg-gray-100 p-2 rounded-md mt-1">I_carga = P / (√3 * U * cos φ)</code><p class="text-sm text-gray-600 mt-2">Para circuitos monofásicos:</p><code class="block bg-gray-100 p-2 rounded-md mt-1">I_carga = P / (U * cos φ)</code></div><div><h5 class="font-semibold text-md">2. Caída de Tensión Porcentual (ΔU%)</h5><p class="text-sm text-gray-600 mt-1">La caída de tensión se calcula como:</p><code class="block bg-gray-100 p-2 rounded-md mt-1">ΔU = K * L * I_carga * (R * cos φ + X * sen φ)</code><p class="text-sm text-gray-600 mt-2">Donde K=2 para monofásico y K=√3 para trifásico. L en [km], R y X en [Ω/km]. Luego, el porcentaje es:</p><code class="block bg-gray-100 p-2 rounded-md mt-1">ΔU% = (ΔU / U) * 100</code></div><div><h5 class="font-semibold text-md">3. Corriente Admisible de Cortocircuito (I<sub>adm cc</sub>)</h5><p class="text-sm text-gray-600 mt-1">Calcula la Icc que el cable soporta térmicamente.</p><code class="block bg-gray-100 p-2 rounded-md mt-1">I_adm_cc = (k * S) / √t</code><p class="text-sm text-gray-600 mt-2">'k' es una constante del material, 'S' es la sección en [mm²], y 't' es el tiempo de la protección en [s].</p></div></div>`,"tab-k1":`<h4 class="text-lg font-semibold mb-4">Factor de Corrección por Temperatura (k1)</h4><p class="text-sm text-gray-600 mb-4">Ajusta la corriente admisible según la temperatura ambiente (Ref: 40°C en aire).</p><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><h5 class="font-semibold mb-2">Aislación PVC (70°C)</h5><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Temp (°C)</th><th class="p-2">Factor (k1)</th></tr></thead><tbody>${k1_temp.PVC.map(row=>`<tr><td class="border p-2">${row.t}</td><td class="border p-2">${row.f}</td></tr>`).join('')}</tbody></table></div><div><h5 class="font-semibold mb-2">Aislación XLPE (90°C)</h5><table class="w-full text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Temp (°C)</th><th class="p-2">Factor (k1)</th></tr></thead><tbody>${k1_temp.XLPE.map(row=>`<tr><td class="border p-2">${row.t}</td><td class="border p-2">${row.f}</td></tr>`).join('')}</tbody></table></div></div>`,"tab-k2":`<h4 class="text-lg font-semibold mb-4">Factor de Corrección por Agrupamiento (k2)</h4><p class="text-sm text-gray-600 mb-4">Para cables en contacto, según la cantidad de circuitos.</p><table class="w-full md:w-1/2 text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Nº Circuitos</th><th class="p-2">Factor (k2)</th></tr></thead><tbody>${k2_agrup.map(row=>`<tr><td class="border p-2">${row.n}</td><td class="border p-2">${row.f.toFixed(2)}</td></tr>`).join('')}</tbody></table>`,"tab-kicc":`<h4 class="text-lg font-semibold mb-4">Constante 'k' para Cálculo de Icc</h4><p class="text-sm text-gray-600 mb-4">Depende del material del conductor y su aislación.</p><table class="w-full md:w-1/2 text-sm text-left"><thead class="bg-gray-100"><tr><th class="p-2">Material / Aislación</th><th class="p-2">Valor de 'k'</th></tr></thead><tbody><tr><td class="border p-2">Cobre / XLPE</td><td class="border p-2">143</td></tr><tr><td class="border p-2">Cobre / PVC</td><td class="border p-2">115</td></tr><tr><td class="border p-2">Aluminio / XLPE</td><td class="border p-2">94</td></tr><tr><td class="border p-2">Aluminio / PVC</td><td class="border p-2">76</td></tr></tbody></table>`,};
            
            let circuits = [];
            let calculationLog = [];

            const addCircuitBtn = document.getElementById('add-circuit');
            const clearListBtn = document.getElementById('clear-list');
            const exportCsvBtn = document.getElementById('export-csv');
            const listaCircuitosEl = document.getElementById('lista-circuitos');
            const emptyListMsg = document.getElementById('empty-list-message');
            const tabContainer = document.getElementById('tab-container-cables');
            const tabContent = document.getElementById('tab-content-cables');
            const manualAnalysisSection = document.getElementById('manual-analysis-section');
            const probarSeccionBtn = document.getElementById('probar-seccion-btn');
            
            addCircuitBtn.addEventListener('click', handleAddCircuit);
            clearListBtn.addEventListener('click', handleClearList);
            exportCsvBtn.addEventListener('click', handleExportCsv);
            document.getElementById('tipoCable').addEventListener('change', updateTendidoOptions);
            document.getElementById('tension').addEventListener('change', updateCaidaTension);
            tabContainer.addEventListener('click', handleTabClick);
            probarSeccionBtn.addEventListener('click', handleProbeSection);


            function handleAddCircuit() {
                const resultDiv = document.getElementById('resultado-cable');
                resultDiv.innerHTML = `<div class="flex justify-center items-center p-4"><div class="loader"></div></div>`;
                resultDiv.style.display = 'block';
                manualAnalysisSection.style.display = 'none';
                document.getElementById('resultado-manual').innerHTML = '';


                setTimeout(() => {
                    const result = selectCircuit();
                    
                    calculationLog.push({type: 'log-header', msg: `--- INICIO CÁLCULO: ${result.userInput.nombre} ---`});
                    calculationLog.push(...(result.log || []));
                    
                    if (result.error) {
                        resultDiv.innerHTML = `<div class="p-4"><div class="text-red-600 bg-red-100 p-4 rounded-lg text-center font-semibold">${result.error}</div></div>`;
                    } else {
                        circuits.push(result);
                        displayImmediateResult(result, resultDiv);
                        renderCircuitList();
                        setupManualAnalysis(result.userInput, result.seccion);
                    }
                    updateLogTab();
                }, 500);
            }

            function handleProbeSection() {
                const resultDiv = document.getElementById('resultado-manual');
                const S = parseFloat(document.getElementById('seccion-manual-select').value);
                if(isNaN(S)) return;

                const userInput = getUserInput();
                const result = calculateSpecificSection(userInput, S);
                
                calculationLog.push(...result.log);
                updateLogTab();

                displayManualResult(result, resultDiv);
            }
            
            function handleRemoveCircuit(index) {
                circuits.splice(index, 1);
                renderCircuitList();
            }

            function handleClearList() {
                circuits = [];
                calculationLog = [];
                renderCircuitList();
                updateLogTab();
            }
            
            function handleExportCsv() {
                if (circuits.length === 0) return;
                
                const headers = ['Nombre Circuito','Potencia (kW)','Tension (V)','FP','Longitud (m)','Tipo Cable','Tendido', 'Icc Proyecto (kA)', 'T Proteccion (s)', 'Seccion (mm²)','I Carga (A)','I Adm (A)', 'Icc Adm Cable (kA)', 'Caida U (%)'];
                
                const rows = circuits.map(c => {
                    const nombre = `"${(c.userInput.nombre || '').replace(/"/g, '""')}"`;
                    return [
                        nombre,
                        c.userInput.P_kW,
                        c.userInput.U,
                        c.userInput.cosphi,
                        c.userInput.L_m,
                        c.userInput.cableKey,
                        c.userInput.tendidoKey, 
                        (c.userInput.icc_kA || 0).toFixed(2), 
                        c.userInput.tiempo_s, 
                        c.seccion, 
                        (c.i_carga || 0).toFixed(2),
                        (c.i_adm || 0).toFixed(2), 
                        (c.i_adm_cc || 0).toFixed(2), 
                        (c.deltaU_perc || 0).toFixed(2)
                    ].join(',');
                });

                const csvContent = [headers.join(','), ...rows].join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                
                const url = URL.createObjectURL(blob);
                link.setAttribute("href", url);
                link.setAttribute("download", "calculo_circuitos.csv");
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function renderCircuitList() {
                listaCircuitosEl.innerHTML = '';
                emptyListMsg.style.display = circuits.length === 0 ? 'block' : 'none';
                exportCsvBtn.disabled = circuits.length === 0;
                circuits.forEach((circuit, index) => {
                    const template = document.getElementById('circuit-card-template');
                    const card = template.content.cloneNode(true).firstElementChild;
                    const { userInput, i_carga, i_adm, deltaU_perc, seccion } = circuit;
                    card.querySelector('h4').textContent = userInput.nombre;
                    card.querySelector('p').textContent = `${userInput.cableKey} - ${userInput.L_m}m`;
                    card.querySelector('.data-seccion').textContent = `${seccion} mm²`;
                    card.querySelector('.data-icarga').textContent = `${i_carga.toFixed(2)} A`;
                    card.querySelector('.data-iadm').textContent = `${i_adm.toFixed(2)} A`;
                    card.querySelector('.data-delta-u').textContent = `${deltaU_perc.toFixed(2)}%`;
                    card.style.borderColor = '#22c55e';
                    card.querySelector('.remove-card').addEventListener('click', () => handleRemoveCircuit(index));
                    listaCircuitosEl.appendChild(card);
                });
            }
            
            function displayImmediateResult(result, container) {
                const checkOK = `<svg class="w-5 h-5 ok-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                const contentHTML = `
                    <div class="p-4">
                        <h3 class="text-lg font-semibold mb-2 text-gray-800 border-t pt-4">Resultado del Cálculo Automático</h3>
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <div class="result-line"><span>1. Verificación Icc</span><div class="flex items-center gap-2"><strong>${result.i_adm_cc.toFixed(2)} kA ≥ ${result.userInput.icc_kA.toFixed(2)} kA</strong>${checkOK}</div></div>
                            <div class="result-line"><span>2. Verificación I<sub>carga</sub></span><div class="flex items-center gap-2"><strong>${result.i_adm.toFixed(2)} A ≥ ${result.i_carga.toFixed(2)} A</strong>${checkOK}</div></div>
                            <div class="result-line"><span>3. Verificación ΔU</span><div class="flex items-center gap-2"><strong>${result.deltaU_perc.toFixed(2)}% ≤ ${result.userInput.deltaU_adm_perc}%</strong>${checkOK}</div></div>
                            <div class="p-2 mt-2 bg-blue-100 rounded-lg text-center">
                                <span class="text-sm text-blue-900">Sección Mínima Requerida</span>
                                <p class="font-bold text-2xl text-blue-900">${result.seccion} mm²</p>
                            </div>
                        </div>
                    </div>`;
                container.innerHTML = contentHTML;
            }

            function displayManualResult(result, container) {
                    const { S, checks, values } = result;
                    const ok = `<svg class="w-5 h-5 ok-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>`;
                    const fail = `<svg class="w-5 h-5 fail-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`;

                    const contentHTML = `
                        <div class="bg-gray-50 p-4 rounded-lg">
                                <div class="result-line ${checks.icc ? 'text-green-700' : 'text-red-600'}"><span>1. Verificación Icc</span><div class="flex items-center gap-2"><strong>${values.i_adm_cc.toFixed(2)} kA ${checks.icc ? '≥' : '<'} ${values.icc_kA.toFixed(2)} kA</strong>${checks.icc ? ok : fail}</div></div>
                                <div class="result-line ${checks.icarga ? 'text-green-700' : 'text-red-600'}"><span>2. Verificación I<sub>carga</sub></span><div class="flex items-center gap-2"><strong>${values.i_adm.toFixed(2)} A ${checks.icarga ? '≥' : '<'} ${values.i_carga.toFixed(2)} A</strong>${checks.icarga ? ok : fail}</div></div>
                                <div class="result-line ${checks.deltaU ? 'text-green-700' : 'text-red-600'}"><span>3. Verificación ΔU</span><div class="flex items-center gap-2"><strong>${values.deltaU_perc.toFixed(2)}% ${checks.deltaU ? '≤' : '>'} ${values.deltaU_adm_perc}%</strong>${checks.deltaU ? ok : fail}</div></div>
                        </div>`;
                container.innerHTML = contentHTML;
            }
            
            function setupManualAnalysis(userInput, idealSection) {
                manualAnalysisSection.style.display = 'block';
                const selectEl = document.getElementById('seccion-manual-select');
                selectEl.innerHTML = '';
                
                const data = cableData[userInput.cableKey];
                const tipoCircuito = userInput.U >= 380 ? 'tri' : 'mono';
                const seccionesDisponibles = data.corrientes[userInput.tendidoKey][tipoCircuito];
                
                seccionesDisponibles.forEach(sec => {
                    const option = document.createElement('option');
                    option.value = sec.s;
                    option.textContent = `${sec.s} mm²`;
                    if(sec.s === idealSection) {
                        option.selected = true;
                    }
                    selectEl.appendChild(option);
                });
            }
            
            function getUserInput(){
                return {
                    P_kW: parseFloat(document.getElementById('potencia').value), U: parseFloat(document.getElementById('tension').value), cosphi: parseFloat(document.getElementById('cosphi').value),
                    L_m: parseFloat(document.getElementById('longitud').value), cableKey: document.getElementById('tipoCable').value, tendidoKey: document.getElementById('tipoTendido').value,
                    temp: parseInt(document.getElementById('temperatura').value), numCircuitos: parseInt(document.getElementById('agrupamiento').value), deltaU_adm_perc: parseFloat(document.getElementById('caidaTensionAdm').value),
                    icc_kA: parseFloat(document.getElementById('icc').value), tiempo_s: parseFloat(document.getElementById('tiempoActuacion').value),
                    nombre: document.getElementById('nombreCircuito').value || `Circuito #${circuits.length + 1}`
                };
            }

            function selectCircuit() {
                const userInput = getUserInput();
                return calculateCable(userInput, true);
            }
            
            function calculateSpecificSection(userInput, S) {
                return calculateCable(userInput, false, S);
            }

            function calculateCable(userInput, findIdeal, specificS = null) {
                let log = [];
                if(!findIdeal) {
                        log.push({type: 'log-manual', msg: `--- Prueba Manual para sección <b>${specificS} mm²</b> ---`});
                }

                if (Object.values(userInput).some(v => v === null || isNaN(v) && typeof v !== 'string')) {
                        return { error: 'Por favor, complete todos los campos numéricos requeridos.' };
                }
                if (userInput.cosphi < 0 || userInput.cosphi > 1) {
                    return { error: 'El Factor de Potencia debe estar entre 0 y 1.' };
                }
                
                const { P_kW, U, cosphi, L_m, cableKey, tendidoKey, temp, numCircuitos, deltaU_adm_perc, icc_kA, tiempo_s } = userInput;
                const P_W = P_kW * 1000; const L_km = L_m / 1000; const tipoCircuito = U >= 380 ? 'tri' : 'mono';
                const data = cableData[cableKey];

                if (!data || !data.corrientes[tendidoKey]) {
                    const errorMsg = `No hay datos para la combinación (${cableKey} / ${tendidoKey}).`;
                    log.push({type: 'fail', msg: errorMsg});
                    return { error: errorMsg, log: log };
                }
                
                const i_carga = tipoCircuito === 'tri' ? (P_W / (Math.sqrt(3) * U * cosphi)) : (P_W / (U * cosphi));
                if(findIdeal) log.push({type: 'step', msg: `Corriente de carga calculada (I<sub>carga</sub>): <b>${i_carga.toFixed(2)} A</b>`});

                const k1 = getK1(data.aislacion, temp); 
                const k2 = getK2(numCircuitos); 
                const k_total = k1 * k2;
                if(findIdeal) log.push({type: 'step', msg: `Factores de corrección: k1=${k1}, k2=${k2}. Total: <b>${k_total.toFixed(2)}</b>`});

                const k_icc = data.k_icc;
                const seccionesDisponibles = data.corrientes[tendidoKey][tipoCircuito];
                if(findIdeal) log.push({type: 'step', msg: 'Iniciando búsqueda de sección...'});

                const sectionsToTest = findIdeal ? seccionesDisponibles : [{s: specificS, i: (seccionesDisponibles.find(sec => sec.s === specificS) || {}).i}];

                for (const seccionInfo of sectionsToTest) {
                    const S = seccionInfo.s;
                    if(!seccionInfo.i) {
                            const errorMsg = `No se encontraron datos de corriente para la sección ${S} mm².`;
                            log.push({type: 'fail', msg: errorMsg});
                            return { error: errorMsg, log: log };
                    }

                    if(findIdeal) log.push({type: 'step', msg: `--- Verificando sección <b>${S} mm²</b> ---`});
                    
                    const i_adm_cc = (k_icc * S) / Math.sqrt(tiempo_s) / 1000;
                    const checkIcc = i_adm_cc >= icc_kA;
                    if(findIdeal && !checkIcc) { log.push({type: 'fail', msg: `<b>Falla Icc:</b> Iadm_cc (${i_adm_cc.toFixed(2)} kA) < Icc_proyecto (${icc_kA.toFixed(2)} kA).`}); continue; }
                    if(findIdeal) log.push({type: 'pass', msg: `<b>Pasa Icc:</b> Iadm_cc (${i_adm_cc.toFixed(2)} kA) ≥ Icc_proyecto (${icc_kA.toFixed(2)} kA).`});

                    const i_adm = seccionInfo.i * k_total;
                    const checkIcarga = i_adm >= i_carga;
                    if(findIdeal && !checkIcarga) { log.push({type: 'fail', msg: `<b>Falla I<sub>carga</sub>:</b> Iadm (${i_adm.toFixed(2)} A) < I<sub>carga</sub> (${i_carga.toFixed(2)} A).`}); continue; }
                    if(findIdeal) log.push({type: 'pass', msg: `<b>Pasa I<sub>carga</sub>:</b> Iadm (${i_adm.toFixed(2)} A) ≥ I<sub>carga</sub> (${i_carga.toFixed(2)} A).`});
                    
                    const params = data.resistencias.find(r => r.s === S);
                    if (!params) { if(findIdeal) log.push({type: 'fail', msg: `No se encontraron R, X para ${S} mm².`}); continue; };
                    
                    const sinphi = Math.sqrt(1 - Math.pow(cosphi, 2));
                    const k_voltDrop = tipoCircuito === 'tri' ? Math.sqrt(3) : 2;
                    const deltaU = k_voltDrop * L_km * i_carga * (params.r * cosphi + params.x * sinphi);
                    const deltaU_perc = (deltaU / U) * 100;
                    const checkDeltaU = deltaU_perc <= deltaU_adm_perc;

                    if(findIdeal && !checkDeltaU) { log.push({type: 'fail', msg: `<b>Falla ΔU:</b> ΔU% (${deltaU_perc.toFixed(2)}%) > ΔU%_adm (${deltaU_adm_perc}%).`}); continue; }
                    if(findIdeal) log.push({type: 'pass', msg: `<b>Pasa ΔU:</b> ΔU% (${deltaU_perc.toFixed(2)}%) ≤ ΔU%_adm (${deltaU_adm_perc}%).`});
                    
                    if (findIdeal) {
                        log.push({type: 'final', msg: `Sección <b>${S} mm²</b> seleccionada. Cumple los 3 criterios.`});
                        return { userInput, i_carga, seccion: S, i_adm, i_adm_cc, deltaU, deltaU_perc, error: null, log: log };
                    } else {
                        return { S, checks: {icc: checkIcc, icarga: checkIcarga, deltaU: checkDeltaU}, values: { i_adm_cc, icc_kA, i_adm, i_carga, deltaU_perc, deltaU_adm_perc }, log };
                    }
                }

                const errorMsg = 'No se encontró sección que cumpla los tres criterios (Icc, Icarga y ΔU). Revise los parámetros.';
                log.push({type: 'fail', msg: `<b>ERROR:</b> ${errorMsg}`});
                return { error: errorMsg, log: log };
            }
            
            function getK1(aislacion, temp) {
                const factors = k1_temp[aislacion];
                if (!factors) return 1;
                let closest = factors.reduce((prev, curr) => (Math.abs(curr.t - temp) < Math.abs(prev.t - temp) ? curr : prev));
                return closest.f;
            }

            function getK2(numCircuitos) {
                if (numCircuitos > 9) return 0.50;
                const factor = k2_agrup.find(f => f.n === numCircuitos);
                return factor ? factor.f : 1;
            }

            function updateTendidoOptions() {
                const tipoTendidoSelect = document.getElementById('tipoTendido');
                tipoTendidoSelect.disabled = this.value.includes('IRAM 247');
                if (tipoTendidoSelect.disabled) {
                    tipoTendidoSelect.innerHTML = '<option value="B1">B1 (Cañería)</option>';
                } else {
                    tipoTendidoSelect.innerHTML = `<option value="B1">B1/B2 (Cañería)</option><option value="C" selected>C (Bandeja no perf.)</option><option value="E">E (Bandeja perf.)</option><option value="F">F (Trébol en bandeja)</option>`;
                }
            }
            
            function updateCaidaTension() {
                document.getElementById('caidaTensionAdm').value = this.value === '220' ? '3' : '5';
            }

            function handleTabClick(e) {
                if (e.target.classList.contains('tab-button-cables')) {
                    const tabId = e.target.dataset.tab;
                    document.querySelectorAll('.tab-button-cables').forEach(btn => btn.classList.remove('active'));
                    e.target.classList.add('active');
                    
                    if(tabId === 'tab-log'){
                        updateLogTab();
                    } else {
                        tabContent.innerHTML = annexContent[tabId] || '';
                    }
                }
            }
            
            function updateLogTab(){
                    if(calculationLog.length === 0){
                        tabContent.innerHTML = `<p class="text-gray-500 text-center">Realice un cálculo para ver la memoria detallada aquí.</p>`;
                    } else {
                        let logHTML = calculationLog.map(entry => {
                            return `<div class="log-entry ${entry.type}">${entry.msg}</div>`;
                        }).join('');
                        tabContent.innerHTML = logHTML;
                    }
            }

            renderCircuitList();
            updateTendidoOptions.call(document.getElementById('tipoCable'));
            handleTabClick({ target: document.querySelector('.tab-button-cables.active') });
        })();


        // ======================================================================
        // --- INICIO: CÓDIGO DE LA CALCULADORA DE PUESTA A TIERRA ---
        // ======================================================================
        (() => {
            const DB = {
                soilResistivity: { '10': 'Arcillas', '5': 'Aluvial', '20': 'Greda', '50': 'Tierra calcárea', '100': 'Arenisca' },
                parallelCoefficients: { 1: 1.0, 2: 0.57, 3: 0.42, 4: 0.33, 5: 0.27, 6: 0.24, 7: 0.21, 8: 0.19, 9: 0.17, 10: 0.15 },
                aeaTable: { 
                    "50": { "30": 1666, "100": 500, "300": 167, "500": 100, "1000": 50, "3000": 17, "5000": 10, "10000": 5, "20000": 2.5 }, 
                    "24": { "30": 800, "100": 240, "300": 80, "500": 48, "1000": 24, "3000": 8, "5000": 4.8, "10000": 2.4, "20000": 1.2 } 
                },
                aeaFinalCap: { "30": 40, "100": 40, "300": 40, "500": 24, "1000": 12, "3000": 4, "5000": 2.4, "10000": 1.2, "20000": 0.6 }
            };
            let sectorCount = 0;
            let currentResults = null;

            const getElement = id => document.getElementById(id);
            const dom_tierra = {
                mode_selector: getElement('mode_selector_tierra'),
                mode_proyecto: getElement('mode_proyecto'),
                mode_domiciliaria: getElement('mode_domiciliaria'),
                tipoSuelo: getElement('tipo_suelo'), 
                resistividadManual: getElement('resistividad_manual'),
                humedadTerreno: getElement('humedad_terreno'),
                ul_condition: getElement('ul_condition'),
                calcularBtn: getElement('calcularBtn'), 
                resultsContainer: getElement('results-container'),
                initialMessage: getElement('initial-message'),
                loaderContainer: getElement('loader-container'),
                exportTextarea: getElement('export-content'), 
                addSectorBtn: getElement('addSectorBtn'),
                sectoresContainer: getElement('sectores-container')
            };

            function addEventListeners_tierra() {
                dom_tierra.mode_selector.addEventListener('change', handleModeChange_tierra);
                dom_tierra.tipoSuelo.addEventListener('change', () => {
                    dom_tierra.resistividadManual.classList.toggle('hidden', dom_tierra.tipoSuelo.value !== 'custom');
                    saveState_tierra();
                });
                dom_tierra.calcularBtn.addEventListener('click', () => {
                    if (dom_tierra.mode_selector.value === 'proyecto' && document.querySelectorAll('.sector-card').length === 0) {
                        alert('Debe añadir al menos un sector de protección.'); return;
                    }
                    dom_tierra.resultsContainer.style.display = 'none';
                    dom_tierra.initialMessage.style.display = 'none';
                    dom_tierra.loaderContainer.style.display = 'flex';
                    setTimeout(performCalculations_tierra, 500);
                });
                dom_tierra.addSectorBtn.addEventListener('click', () => { addSector_tierra(); saveState_tierra(); });

                document.querySelectorAll('#seccion-tierra input, #seccion-tierra select').forEach(el => {
                    el.addEventListener('change', saveState_tierra);
                    el.addEventListener('keyup', saveState_tierra);
                });

                getElement('domiciliaria_electrode_type').addEventListener('change', (e) => handleElectrodeTypeChange_tierra('domiciliaria', e.target.value));
            }

            function saveState_tierra() {
                const state = {
                    mode: dom_tierra.mode_selector.value,
                    ul: dom_tierra.ul_condition.value,
                    tipoSuelo: dom_tierra.tipoSuelo.value,
                    resistividadManual: dom_tierra.resistividadManual.value,
                    humedad: dom_tierra.humedadTerreno.value,
                    domiciliaria: {
                        rcd: getElement('domiciliaria_rcd').value,
                        manualCheck: getElement('domiciliaria_manual_obj_check').checked,
                        manualInput: getElement('domiciliaria_manual_obj_input').value,
                        electrodeType: getElement('domiciliaria_electrode_type').value,
                        l: getElement('domiciliaria_l').value,
                        d: getElement('domiciliaria_d').value,
                        h_l: getElement('domiciliaria_h_l').value,
                        h_p: getElement('domiciliaria_h_p').value,
                        placa_a: getElement('domiciliaria_placa_a').value,
                        placa_b: getElement('domiciliaria_placa_b').value,
                        malla_l: getElement('domiciliaria_malla_l').value,
                        malla_A: getElement('domiciliaria_malla_A').value,
                    },
                    proyecto: {
                        service_l: getElement('proyecto_service_l').value,
                        service_d: getElement('proyecto_service_d').value,
                        service_manual_check: getElement('proyecto_service_manual_check').checked,
                        service_manual_input: getElement('proyecto_service_manual_input').value,
                        sectores: Array.from(document.querySelectorAll('.sector-card')).map(card => ({
                            id: card.id,
                            name: card.querySelector('.sector-name').value,
                            rcd: card.querySelector('.sector-rcd').value,
                            manualCheck: card.querySelector('.sector-manual-check').checked,
                            manualInput: card.querySelector('.sector-manual-input').value,
                            electrodeType: card.querySelector('.sector-electrode-type').value,
                            l: card.querySelector('.sector-l').value,
                            d: card.querySelector('.sector-d').value,
                        }))
                    }
                };
                localStorage.setItem('pat_calculator_state', JSON.stringify(state));
            }

            function loadState_tierra() {
                const state = JSON.parse(localStorage.getItem('pat_calculator_state'));
                if (!state) return;

                dom_tierra.mode_selector.value = state.mode || 'domiciliaria';
                dom_tierra.ul_condition.value = state.ul || '24';
                dom_tierra.tipoSuelo.value = state.tipoSuelo || '10';
                dom_tierra.resistividadManual.value = state.resistividadManual || '';
                dom_tierra.humedadTerreno.value = state.humedad || '1.0';
                dom_tierra.resistividadManual.classList.toggle('hidden', dom_tierra.tipoSuelo.value !== 'custom');

                const domState = state.domiciliaria || {};
                getElement('domiciliaria_rcd').value = domState.rcd || '30';
                getElement('domiciliaria_manual_obj_check').checked = domState.manualCheck || false;
                getElement('domiciliaria_manual_obj_input').value = domState.manualInput || '';
                getElement('domiciliaria_manual_obj_input').classList.toggle('hidden', !domState.manualCheck);
                getElement('domiciliaria_electrode_type').value = domState.electrodeType || 'jabalina_v';
                getElement('domiciliaria_l').value = domState.l || '3';
                getElement('domiciliaria_d').value = domState.d || '0.01905';
                getElement('domiciliaria_h_l').value = domState.h_l || '10';
                getElement('domiciliaria_h_p').value = domState.h_p || '0.5';
                getElement('domiciliaria_placa_a').value = domState.placa_a || '1';
                getElement('domiciliaria_placa_b').value = domState.placa_b || '1';
                getElement('domiciliaria_malla_l').value = domState.malla_l || '5';
                getElement('domiciliaria_malla_A').value = domState.malla_A || '4';
                
                const proyState = state.proyecto || {};
                getElement('proyecto_service_l').value = proyState.service_l || '3';
                getElement('proyecto_service_d').value = proyState.service_d || '0.01905';
                getElement('proyecto_service_manual_check').checked = proyState.service_manual_check || false;
                getElement('proyecto_service_manual_input').value = proyState.service_manual_input || '1';
                getElement('proyecto_service_manual_input').classList.toggle('hidden', !proyState.service_manual_check);
                
                dom_tierra.sectoresContainer.innerHTML = '';
                sectorCount = 0;
                if (proyState.sectores && proyState.sectores.length > 0) {
                    proyState.sectores.forEach(s => addSector_tierra(s));
                }
            }

            function handleModeChange_tierra() {
                const selectedMode = dom_tierra.mode_selector.value;
                document.querySelectorAll('#seccion-tierra .mode-section').forEach(el => el.style.display = 'none');
                const modeElement = getElement(`mode_${selectedMode}`);
                modeElement.style.display = 'block';

                if (selectedMode === 'domiciliaria') {
                    const selectedElectrode = getElement('domiciliaria_electrode_type').value;
                    handleElectrodeTypeChange_tierra('domiciliaria', selectedElectrode);
                }

                dom_tierra.resultsContainer.style.display = 'none';
                dom_tierra.initialMessage.style.display = 'flex';
                dom_tierra.calcularBtn.textContent = selectedMode === 'proyecto' ? 'Calcular Proyecto Completo' : 'Verificar Puesta a Tierra';
                saveState_tierra();
            }

            function handleElectrodeTypeChange_tierra(prefix, type, card) {
                const container = card || document;
                container.querySelectorAll(`[id^=${prefix}_][id$=_params]`).forEach(el => el.style.display = 'none');
                const selectedParams = container.querySelector(`#${prefix}_${type}_params`);
                if (selectedParams) selectedParams.style.display = 'block';
            }

            function addSector_tierra(data = {}) {
                sectorCount++;
                const sectorId = data.id || `sector-${sectorCount}`;
                const newSector = document.createElement('div');
                newSector.className = 'sector-card p-4 rounded-lg';
                newSector.id = sectorId;
                newSector.innerHTML = `
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold">Sector de Protección #${sectorCount}</h4>
                        <button onclick="removeSector_tierra('${sectorId}')" class="text-gray-500 hover:text-red-500 text-2xl leading-none">&times;</button>
                    </div>
                    <div class="space-y-3">
                        <input type="text" placeholder="Nombre (Ej: Taller)" class="sector-name w-full input-group text-sm" value="${data.name || `Sector ${sectorCount}`}">
                        <div>
                            <label class="text-xs">Sensibilidad Diferencial (IΔn)</label>
                            <select class="sector-rcd w-full input-group mt-1 text-sm">
                                <option value="30">30 mA</option><option value="100">100 mA</option><option value="300">300 mA</option>
                                <option value="500">500 mA</option><option value="1000">1 A</option><option value="3000">3 A</option>
                            </select>
                        </div>
                            <div class="mt-2">
                            <label class="flex items-center space-x-2 text-sm cursor-pointer">
                                <input type="checkbox" class="sector-manual-check form-checkbox h-4 w-4 text-blue-600 rounded">
                                <span>Usar objetivo manual</span>
                            </label>
                            <input type="number" class="sector-manual-input w-full input-group mt-2 hidden" placeholder="Ej: 5 Ω">
                        </div>
                        <div>
                            <label class="text-xs">Tipo de Electrodo</label>
                            <select class="sector-electrode-type w-full input-group mt-1 text-sm">
                                    <option value="jabalina_v" selected>Jabalina Vertical</option>
                            </select>
                        </div>
                        <div class="sector-l-d-params">
                                <label class="text-xs">Jabalina del Sector</label>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <select class="sector-l w-full input-group text-sm"><option value="1.5">1.5m</option><option value="3" selected>3m</option></select>
                                <select class="sector-d w-full input-group text-sm"><option value="0.0127">1/2"</option><option value="0.0158">5/8"</option><option value="0.01905" selected>3/4"</option></select>
                            </div>
                        </div>
                    </div>`;
                
                if (data.rcd) newSector.querySelector('.sector-rcd').value = data.rcd;
                if (data.manualCheck) {
                    newSector.querySelector('.sector-manual-check').checked = true;
                    newSector.querySelector('.sector-manual-input').value = data.manualInput || '';
                    newSector.querySelector('.sector-manual-input').classList.remove('hidden');
                }
                if(data.electrodeType) newSector.querySelector('.sector-electrode-type').value = data.electrodeType;
                if(data.l) newSector.querySelector('.sector-l').value = data.l;
                if(data.d) newSector.querySelector('.sector-d').value = data.d;

                newSector.querySelector('.sector-manual-check').addEventListener('change', (e) => {
                    e.target.closest('div').querySelector('.sector-manual-input').classList.toggle('hidden', !e.target.checked);
                    saveState_tierra();
                });
                
                newSector.querySelector('.sector-electrode-type').disabled = true;

                dom_tierra.sectoresContainer.appendChild(newSector);
                newSector.querySelectorAll('input, select').forEach(el => {
                    el.addEventListener('change', saveState_tierra);
                    el.addEventListener('keyup', saveState_tierra);
                });
            }

            getElement('domiciliaria_manual_obj_check').addEventListener('change', (e) => {
                getElement('domiciliaria_manual_obj_input').classList.toggle('hidden', !e.target.checked);
                saveState_tierra();
            });
            getElement('proyecto_service_manual_check').addEventListener('change', (e) => {
                getElement('proyecto_service_manual_input').classList.toggle('hidden', !e.target.checked);
                saveState_tierra();
            });

            window.removeSector_tierra = function(sectorId) { 
                getElement(sectorId).remove(); 
                saveState_tierra();
            }

            function getInputs_tierra() {
                const resistividadBase = dom_tierra.tipoSuelo.value === 'custom' ? parseFloat(dom_tierra.resistividadManual.value) : parseFloat(dom_tierra.tipoSuelo.value);
                const humedadFactor = parseFloat(dom_tierra.humedadTerreno.value);
                const resistividadFinal = resistividadBase * humedadFactor;

                const mode = dom_tierra.mode_selector.value;
                const baseParams = { 
                    mode, 
                    ul: dom_tierra.ul_condition.value, 
                    resistividad: isNaN(resistividadFinal) ? 0 : resistividadFinal 
                };

                if (mode === 'proyecto') {
                    baseParams.sectores = Array.from(document.querySelectorAll('.sector-card')).map(card => ({
                        name: card.querySelector('.sector-name').value,
                        rcd: card.querySelector('.sector-rcd').value,
                        l: parseFloat(card.querySelector('.sector-l').value),
                        d: parseFloat(card.querySelector('.sector-d').value),
                        manualCheck: card.querySelector('.sector-manual-check').checked,
                        manualInput: parseFloat(card.querySelector('.sector-manual-input').value),
                        electrodeType: 'jabalina_v'
                    }));
                    baseParams.service = {
                            l: parseFloat(getElement('proyecto_service_l').value),
                            d: parseFloat(getElement('proyecto_service_d').value),
                            manualCheck: getElement('proyecto_service_manual_check').checked,
                            manualInput: parseFloat(getElement('proyecto_service_manual_input').value)
                    };
                } else {
                    baseParams.domiciliaria = {
                        rcd: getElement('domiciliaria_rcd').value,
                        manualCheck: getElement('domiciliaria_manual_obj_check').checked,
                        manualInput: parseFloat(getElement('domiciliaria_manual_obj_input').value),
                        electrodeType: getElement('domiciliaria_electrode_type').value,
                        l: parseFloat(getElement('domiciliaria_l').value),
                        d: parseFloat(getElement('domiciliaria_d').value),
                        h_l: parseFloat(getElement('domiciliaria_h_l').value),
                        h_p: parseFloat(getElement('domiciliaria_h_p').value),
                        placa_a: parseFloat(getElement('domiciliaria_placa_a').value),
                        placa_b: parseFloat(getElement('domiciliaria_placa_b').value),
                        malla_l: parseFloat(getElement('domiciliaria_malla_l').value),
                        malla_A: parseFloat(getElement('domiciliaria_malla_A').value),
                    };
                }
                return baseParams;
            }

            function getPatObjective_tierra(rcd, ul, manualCheck, manualValue) {
                if(manualCheck && !isNaN(manualValue) && manualValue > 0) return manualValue;
                const calculated_ra = DB.aeaTable[ul]?.[rcd] || Infinity;
                const capped_ra = DB.aeaFinalCap[rcd] || calculated_ra;
                return Math.min(calculated_ra, capped_ra);
            }

            function calculateJabalinaVertical_tierra(resistividad, L, d) {
                if (L <= 0 || d <= 0) return Infinity;
                return (resistividad / (2 * Math.PI * L)) * Math.log((4 * L / d) - 1);
            }

            function calculateJabalinaHorizontal_tierra(resistividad, L, p) {
                if (L <= 0 || p <= 0) return Infinity;
                return (resistividad / (2 * Math.PI * L)) * (Math.log((4 * L * L) / p) - 1);
            }

            function calculatePlaca_tierra(resistividad, a, b) {
                if (a <= 0 || b <= 0) return Infinity;
                const P = 2 * (a + b);
                return (resistividad / P) * (Math.PI / 2);
            }

            function calculateMalla_tierra(resistividad, L_total, Area) {
                if (L_total <= 0 || Area <= 0) return Infinity;
                return resistividad * ((1 / L_total) + (1 / Math.sqrt(20 * Area)));
            }

            function calculatePat_tierra(params, objetivo) {
                let Rj = Infinity;
                const { resistividad, electrodeType } = params;

                switch(electrodeType) {
                    case 'jabalina_v': Rj = calculateJabalinaVertical_tierra(resistividad, params.l, params.d); break;
                    case 'jabalina_h': Rj = calculateJabalinaHorizontal_tierra(resistividad, params.h_l, params.h_p); break;
                    case 'placa': Rj = calculatePlaca_tierra(resistividad, params.placa_a, params.placa_b); break;
                    case 'malla': Rj = calculateMalla_tierra(resistividad, params.malla_l, params.malla_A); break;
                }

                let numElectrodos = 0, Rt = Infinity;
                if (Rj <= objetivo) {
                    numElectrodos = 1; Rt = Rj;
                } else if (electrodeType === 'jabalina_v') {
                    for (let i = 2; i <= 10; i++) {
                        const k = DB.parallelCoefficients[i];
                        const currentRt = k * Rj;
                        if (currentRt <= objetivo) { numElectrodos = i; Rt = currentRt; break; }
                    }
                    if (numElectrodos === 0) { numElectrodos = 10; Rt = DB.parallelCoefficients[10] * Rj; }
                } else {
                    numElectrodos = 1; Rt = Rj;
                }
                
                const Re = (electrodeType === 'jabalina_v' && params.l > 0 && params.d > 0) ? (params.l / Math.log(params.l / params.d)) : 0;
                
                return { Rj, Rt, numElectrodos, Re, cumple: Rt <= objetivo, objetivo, ...params };
            }
            
            function performCalculations_tierra() {
                const params = getInputs_tierra();
                if (params.resistividad <= 0) {
                    alert('Por favor, ingrese un valor de resistividad válido.');
                    dom_tierra.loaderContainer.style.display = 'none';
                    dom_tierra.initialMessage.style.display = 'flex';
                    return;
                }

                if (params.mode === 'proyecto') {
                    const srv = params.service;
                    const srvObjective = srv.manualCheck && !isNaN(srv.manualInput) ? srv.manualInput : 1.0;
                    const patServiceParams = { resistividad: params.resistividad, electrodeType: 'jabalina_v', l: srv.l, d: srv.d };
                    const patService = calculatePat_tierra(patServiceParams, srvObjective);
                    patService.isManual = srv.manualCheck;

                    const patProteccion = params.sectores.map(sector => {
                        const objective = getPatObjective_tierra(sector.rcd, params.ul, sector.manualCheck, sector.manualInput);
                        const patParams = { resistividad: params.resistividad, electrodeType: sector.electrodeType, l: sector.l, d: sector.d };
                        const result = {
                            ...calculatePat_tierra(patParams, objective),
                            name: sector.name, rcd: sector.rcd, isManual: sector.manualCheck
                        };
                        return result;
                    });
                    currentResults = { params, patService, patProteccion };
                } else {
                    const p = params.domiciliaria;
                    const objective = getPatObjective_tierra(p.rcd, params.ul, p.manualCheck, p.manualInput);
                    const patParams = { resistividad: params.resistividad, ...p };
                    const patUnica = calculatePat_tierra(patParams, objective);
                    patUnica.isManual = p.manualCheck;
                    patUnica.rcd = p.rcd;
                    currentResults = { params, patUnica };
                }
                displayResults_tierra(currentResults);
            }

            function displayResults_tierra(results) {
                dom_tierra.loaderContainer.style.display = 'none';
                dom_tierra.resultsContainer.style.display = 'block';
                const content = results.params.mode === 'proyecto' ? generateProjectContent_tierra(results) : generateDomiciliariaContent_tierra(results);
                dom_tierra.resultsContainer.innerHTML = content;
                document.querySelectorAll('#seccion-tierra .tab-button').forEach(button => button.addEventListener('click', e => switchTab_tierra(e.currentTarget)));
                getElement('results-container').addEventListener('click', (e) => {
                    if (e.target.closest('#exportTxtBtn')) exportToTxt_tierra();
                    if (e.target.closest('#exportCsvBtn')) exportToCsv_tierra();
                });
                if (window.MathJax) MathJax.typesetPromise();
                switchTab_tierra(document.querySelector('#seccion-tierra .tab-button[data-tab="resultados"]'));
            }
            
            function generateBaseLayout_tierra(title, content) {
                    return `
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 border-b pb-4">
                            <h2 class="text-2xl font-semibold">${title}</h2>
                            <div class="flex space-x-2 mt-4 sm:mt-0">
                                <button id="exportTxtBtn" class="btn btn-primary btn-sm">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                                    Copiar Informe
                                </button>
                                <button id="exportCsvBtn" class="btn bg-green-600 hover:bg-green-700 text-white btn-sm">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                                    Exportar CSV
                                </button>
                            </div>
                        </div>
                        <div class="border-b mb-6">
                            <nav class="flex space-x-1 sm:space-x-2 overflow-x-auto" aria-label="Tabs">
                                <button class="tab-button active py-2 px-3 sm:px-4 text-sm font-medium" data-tab="resultados">Resultados</button>
                                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="calculos">Anexo: Cálculos</button>
                                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="formulas">Anexo: Fórmulas</button>
                                <button class="tab-button py-2 px-3 sm:px-4 text-sm font-medium" data-tab="tablas">Anexo: Tablas</button>
                            </nav>
                        </div>
                        <div id="tab-content-tierra">${content}</div>`;
            }

            function switchTab_tierra(clickedButton) {
                document.querySelectorAll('#seccion-tierra .tab-button').forEach(btn => btn.classList.remove('active'));
                clickedButton.classList.add('active');
                document.querySelectorAll('#seccion-tierra .result-section').forEach(section => section.style.display = 'none');
                getElement(`tab-${clickedButton.dataset.tab}`).style.display = 'block';
            }

            function createResultCard_tierra(title, id, {Rt, Rj, numElectrodos, cumple, objetivo, rcd, isManual, electrodeType}) {
                const statusClass = cumple ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                const objectiveType = isManual ? '(Manual)' : `(Reglamento, ${rcd}mA)`;
                const solutionText = electrodeType === 'jabalina_v' ? `${numElectrodos} Jabalina(s)` : '1 Electrodo';
                
                return `<div class="info-card p-4 rounded-lg flex flex-col h-full">
                                <h4 class="font-bold text-lg">${title} <span class="text-sm font-normal">(${id})</span></h4>
                                <div class="mt-3 space-y-2 text-sm flex-grow">
                                    <div class="flex justify-between"><span>Resistencia 1 Electrodo (Rj):</span><span class="font-semibold">${Rj.toFixed(2)} Ω</span></div>
                                    <div class="flex justify-between"><span>Objetivo ${objectiveType}:</span><span class="font-semibold">≤ ${objetivo.toFixed(1)} Ω</span></div>
                                    <hr class="border-gray-300 my-2">
                                    <div class="flex justify-between text-base"><b>Solución Propuesta:</b><span class="font-bold">${solutionText}</span></div>
                                    <div class="flex justify-between"><span>Resistencia Final (RT):</span><span class="font-bold text-lg">${Rt.toFixed(2)} Ω</span></div>
                                </div>
                                <div class="mt-4">
                                    ${generateSvgResult_tierra(numElectrodos, electrodeType)}
                                </div>
                                <div class="mt-3 text-center text-sm font-bold p-1 rounded ${statusClass}">${cumple ? 'CUMPLE' : 'NO CUMPLE'}</div>
                            </div>`;
            }
            function generateProjectResultsTab_tierra({ patService, patProteccion }) {
                const serviceCard = createResultCard_tierra('Puesta a Tierra de Servicio', 'RB', patService);
                const protectionCards = patProteccion.map((p, i) => createResultCard_tierra(p.name, `RA${i+1}`, p)).join('');
                return `<div id="tab-resultados" class="result-section space-y-6"><div><h3 class="text-xl font-semibold mb-3">1. Sistema de Servicio (Neutro)</h3><p class="text-sm mb-2">Puesta a tierra para estabilidad de la red.</p>${serviceCard}</div><div><h3 class="text-xl font-semibold mb-3">2. Sistemas de Protección (Masas)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4">${protectionCards}</div></div><div><h3 class="text-xl font-semibold mb-3">3. Requisito de Separación</h3><div class="info-card p-4 rounded-lg"><p class="text-sm">Separación Mínima entre Jabalinas de distintos sistemas (Recomendado > 5m). Aplicable solo a jabalinas verticales.</p><p class="text-2xl font-bold">${(patService.Re > 0 ? (patService.Re * 10).toFixed(2) : 'N/A')} m</p></div></div></div>`;
            }
            function generateProjectCalculosTab_tierra({ patService, patProteccion, params }) {
                const serviceCalc = `RT = K * Rj = ${DB.parallelCoefficients[patService.numElectrodos]} * ${patService.Rj.toFixed(2)} = ${patService.Rt.toFixed(2)} Ω`;
                const protectionCalcs = patProteccion.map((p, i) => `<div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-700">Cálculo para ${p.name} (RA${i+1})</h4><p class="font-mono text-sm break-words">Rj = (${params.resistividad.toFixed(2)} / (2π * ${p.l})) * ln((4*${p.l}/${p.d}) - 1) = ${p.Rj.toFixed(2)} Ω</p><p class="font-mono text-sm break-words">RT = K * Rj = ${DB.parallelCoefficients[p.numElectrodos]} * ${p.Rj.toFixed(2)} = ${p.Rt.toFixed(2)} Ω</p><p class="text-xs text-gray-500 mt-2">Objetivo ${p.isManual ? '(Manual)' : `(Reglamento, ${p.rcd}mA, UL=${params.ul}V)`}: ≤ ${p.objetivo} Ω</p></div>`).join('');
                return `<div id="tab-calculos" class="result-section space-y-4"><div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-700">Cálculo para Servicio (RB)</h4><p class="font-mono text-sm break-words">Rj (${patService.l}m x ${patService.d}m) = (${params.resistividad.toFixed(2)} / (2π * ${patService.l})) * ln((4*${patService.l}/${patService.d}) - 1) = ${patService.Rj.toFixed(2)} Ω</p><p class="font-mono text-sm break-words">${serviceCalc}</p></div>${protectionCalcs}</div>`;
            }
            function generateDomiciliariaResultsTab_tierra({ patUnica }) {
                return `<div id="tab-resultados" class="result-section">${createResultCard_tierra('Verificación Domiciliaria', 'RA', patUnica)}</div>`;
            }
            function generateDomiciliariaCalculosTab_tierra({ patUnica, params }) {
                const { Rj, Rt, numElectrodos, objetivo, rcd, isManual, electrodeType } = patUnica;
                const { resistividad, ul } = params;
                let rjFormula = '';
                switch(electrodeType){
                    case 'jabalina_v': rjFormula = `Rj = (${resistividad.toFixed(2)} / (2π * ${patUnica.l})) * ln((4*${patUnica.l}/${patUnica.d}) - 1) = ${Rj.toFixed(2)} Ω`; break;
                    case 'jabalina_h': rjFormula = `Rj = (${resistividad.toFixed(2)} / (2π * ${patUnica.h_l})) * (ln(4*${patUnica.h_l}²/${patUnica.h_p}) - 1) = ${Rj.toFixed(2)} Ω`; break;
                    case 'placa': rjFormula = `Rj ≈ (${resistividad.toFixed(2)} / (2*(${patUnica.placa_a}+${patUnica.placa_b}))) * (π/2) = ${Rj.toFixed(2)} Ω`; break;
                    case 'malla': rjFormula = `Rj ≈ ${resistividad.toFixed(2)} * (1/${patUnica.malla_l} + 1/√20*${patUnica.malla_A}) = ${Rj.toFixed(2)} Ω`; break;
                }

                return `<div id="tab-calculos" class="result-section space-y-4">
                    <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-700">1. Cálculo de Resistencia de Electrodo (Rj)</h4><p class="font-mono text-sm break-words">${rjFormula}</p></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-700">2. Determinación de Resistencia Máxima (RA max)</h4><p class="font-mono text-sm break-words">${ isManual ? `Objetivo Manual: ${objetivo} Ω` : `RA_max = min(UL/IΔn, Límite_Tabla) = ${objetivo} Ω`}</p></div>
                    <div class="bg-gray-50 p-4 rounded-lg"><h4 class="font-semibold mb-2 text-blue-700">3. Cálculo de Sistema Final (RT)</h4><p class="font-mono text-sm break-words">${numElectrodos === 1 ? 'RT = Rj' : `RT = K * Rj = ${DB.parallelCoefficients[numElectrodos]} * ${Rj.toFixed(2)}`} = ${Rt.toFixed(2)} Ω</p></div>
                    </div>`;
            }
                function generateFormulasTab_tierra() {
                    return `<div id="tab-formulas" class="result-section space-y-6">
                        <div><h4 class="font-semibold text-lg text-blue-700">Resistencia Jabalina Vertical (Rj)</h4><div class="bg-gray-100 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_j = \\left(\\frac{\\rho}{2 \\cdot \\pi \\cdot L}\\right) \\cdot \\ln\\left(\\frac{4L}{d} - 1\\right) $$</div></div>
                        <div><h4 class="font-semibold text-lg text-blue-700">Resistencia Jabalinas en Paralelo (RT)</h4><div class="bg-gray-100 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_T = K \\cdot R_j $$</div></div>
                        <div><h4 class="font-semibold text-lg text-blue-700">Resistencia Máxima de Protección (RA)</h4><div class="bg-gray-100 p-4 rounded-lg mt-2 font-mono text-center text-lg">$$ R_A \\le \\frac{U_L}{I_{\\Delta n}} $$</div></div>
                        <p class="text-xs text-gray-500">Nota: Las fórmulas para placas, mallas y jabalinas horizontales son aproximaciones simplificadas para esta herramienta.</p>
                        </div>`;
                }
                function generateTablasTab_tierra() {
                    const soilRows = Object.entries(DB.soilResistivity).map(([val, name]) => `<tr><td class="p-3">${name}</td><td class="p-3 text-right">${val} Ω·m</td></tr>`).join('');
                    const parallelRows = Object.entries(DB.parallelCoefficients).map(([n, k]) => `<tr><td class="p-3">${n}</td><td class="p-3 text-right">${k}</td></tr>`).join('');
                    const rcdRows = Object.entries(DB.aeaFinalCap).map(([rcd, res]) => `<tr><td class="p-3">${parseInt(rcd) < 1000 ? rcd + ' mA' : rcd/1000 + ' A'}</td><td class="p-3 text-right">${DB.aeaTable['50'][rcd] || '-'} Ω</td><td class="p-3 text-right">${DB.aeaTable['24'][rcd] || '-'} Ω</td><td class="p-3 text-right font-bold">${res} Ω</td></tr>`).join('');
                    return `<div id="tab-tablas" class="result-section"><div class="grid grid-cols-1 gap-6"><div class="lg:col-span-2"><h4 class="font-semibold mb-3 text-blue-700">Tabla 1: Resistencia Máxima de Protección vs. Diferencial (AEA 90364)</h4><div class="overflow-x-auto bg-gray-50 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-200 text-xs uppercase"><tr><th class="p-3" rowspan="2">Sensibilidad (IΔn)</th><th class="p-3 text-center" colspan="3">Resistencia Máxima (RA)</th></tr><tr><th class="p-3 text-right">UL = 50V</th><th class="p-3 text-right">UL = 24V</th><th class="p-3 text-right font-bold">Valor Final</th></tr></thead><tbody class="divide-y divide-gray-200">${rcdRows}</tbody></table></div></div><div class="grid grid-cols-1 lg:grid-cols-2 gap-6"><div><h4 class="font-semibold mb-3 text-blue-700">Tabla 2: Resistividad del Terreno</h4><div class="overflow-x-auto bg-gray-50 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-200 text-xs uppercase"><tr><th class="p-3">Tipo de Suelo</th><th class="p-3 text-right">Valor</th></tr></thead><tbody class="divide-y divide-gray-200">${soilRows}</tbody></table></div></div><div><h4 class="font-semibold mb-3 text-blue-700">Tabla 3: Coeficientes Paralelo (K)</h4><div class="overflow-x-auto bg-gray-50 rounded-lg"><table class="w-full text-sm text-left"><thead class="bg-gray-200 text-xs uppercase"><tr><th class="p-3">N° Jabalinas</th><th class="p-3 text-right">K</th></tr></thead><tbody class="divide-y divide-gray-200">${parallelRows}</tbody></table></div></div></div></div></div>`;
                }
            
            function generateSvgResult_tierra(count, type) {
                let svgContent = '';
                const spacing = 30;
                const totalWidth = count * 10 + (count - 1) * (spacing - 10);
                
                switch(type) {
                    case 'jabalina_v':
                        for (let i = 0; i < count; i++) {
                            svgContent += `<rect x="${i * spacing}" y="10" width="10" height="50" fill="#9CA3AF" />`;
                        }
                        if (count > 1) {
                            svgContent += `<line x1="5" y1="5" x2="${totalWidth - 5}" y2="5" stroke="#9CA3AF" stroke-width="2" />`;
                            for (let i = 0; i < count; i++) {
                                svgContent += `<line x1="${i * spacing + 5}" y1="5" x2="${i * spacing + 5}" y2="10" stroke="#9CA3AF" stroke-width="2" />`;
                            }
                        }
                        return `<svg viewBox="-5 0 ${totalWidth + 10} 70" class="mx-auto h-20">${svgContent}</svg>`;
                    case 'jabalina_h':
                        return `<svg viewBox="0 0 100 30" class="mx-auto h-12"><rect x="5" y="10" width="90" height="10" fill="#9CA3AF" /></svg>`;
                    case 'placa':
                        return `<svg viewBox="0 0 60 40" class="mx-auto h-16"><rect x="5" y="5" width="50" height="30" fill="#9CA3AF" /></svg>`;
                    case 'malla':
                        return `<svg viewBox="0 0 100 60" class="mx-auto h-20">
                            <defs><pattern id="grid" width="20" height="20" patternUnits="userSpaceOnUse"><path d="M 20 0 L 0 0 0 20" fill="none" stroke="#9CA3AF" stroke-width="1"/></pattern></defs>
                            <rect width="100" height="60" fill="url(#grid)" stroke="#9CA3AF" stroke-width="2" />
                        </svg>`;
                }
                return '';
            }

            function exportToTxt_tierra() {
                if (!currentResults) { alert("Primero debe realizar un cálculo."); return; }
                let report = `Informe de Puesta a Tierra\n============================\n`;
                report += `Modo: ${currentResults.params.mode}\nResistividad: ${currentResults.params.resistividad.toFixed(2)} ohm.m\n`;
                if(currentResults.patUnica){
                    report += `Resultado Domiciliaria: ${currentResults.patUnica.Rt.toFixed(2)} ohm (${currentResults.patUnica.cumple ? 'CUMPLE' : 'NO CUMPLE'})`;
                }
                dom_tierra.exportTextarea.value = report;
                dom_tierra.exportTextarea.select();
                try { document.execCommand('copy'); alert('¡Informe copiado al portapapeles!'); } catch (err) { alert('Error al copiar.'); }
            }

            function exportToCsv_tierra() {
                if (!currentResults) { alert("Primero debe realizar un cálculo."); return; }
                let csvContent = "data:text/csv;charset=utf-8,";
                const headers = "Tipo Sistema,Nombre/ID,Resultado,Resistencia Final (ohm),Electrodos Necesarios,Objetivo (ohm),Resistividad (ohm.m)\n";
                csvContent += headers;
                const { params } = currentResults;
                    if (params.mode === 'proyecto') {
                        const { patService, patProteccion } = currentResults;
                        csvContent += `Servicio,RB,${patService.cumple ? 'CUMPLE' : 'NO CUMPLE'},${patService.Rt.toFixed(2)},${patService.numElectrodos},${patService.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
                        patProteccion.forEach((p, i) => {
                            csvContent += `Proteccion,${p.name} (RA${i+1}),${p.cumple ? 'CUMPLE' : 'NO CUMPLE'},${p.Rt.toFixed(2)},${p.numElectrodos},${p.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
                        });
                } else {
                    const { patUnica } = currentResults;
                    csvContent += `Proteccion,Domiciliaria (RA),${patUnica.cumple ? 'CUMPLE' : 'NO CUMPLE'},${patUnica.Rt.toFixed(2)},${patUnica.numElectrodos},${patUnica.objetivo.toFixed(1)},${params.resistividad.toFixed(2)}\n`;
                }
                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", "calculo_puesta_a_tierra.csv");
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            addEventListeners_tierra();
            loadState_tierra();
            handleModeChange_tierra();
            if (dom_tierra.mode_selector.value === 'proyecto' && document.querySelectorAll('.sector-card').length === 0) {
                addSector_tierra();
            }
        })();


        // ======================================================================
        // --- INICIO: CÓDIGO DE LA CALCULADORA DE CORTOCIRCUITO ---
        // ======================================================================
        (() => {
            const CONSTS = {
                CABLE_SECTIONS: ["1.5", "2.5", "4", "6", "10", "16", "25", "35", "50", "70", "95", "120", "150", "185", "240", "300", "400", "500", "630"],
                CABLE_RESISTANCE: {
                    cobre: {
                        pvc:  {'1.5':15.91,'2.5':9.55,'4':5.92,'6':3.95,'10':2.29,'16':1.48,'25':0.934,'35':0.663,'50':0.463,'70':0.326,'95':0.248,'120':0.195,'150':0.157,'185':0.13,'240':0.1, '300': 0.082, '400': 0.062, '500': 0.051, '630': 0.041},
                        xlpe: {'1.5':16.96,'2.5':10.18,'4':6.31,'6':4.21,'10':2.44,'16':1.54,'25':0.995,'35':0.707,'50':0.493,'70':0.348,'95':0.264,'120':0.207,'150':0.167,'185':0.138,'240':0.106, '300': 0.086, '400': 0.064, '500': 0.052, '630': 0.042}
                    },
                    aluminio: {
                        pvc:  {'16':2.392,'25':1.513,'35':1.093,'50':0.800,'70':0.558,'95':0.403,'120':0.321,'150':0.262,'185':0.209,'240':0.161, '300': 0.128, '400': 0.102, '500': 0.084, '630': 0.067},
                        xlpe: {'16':2.392,'25':1.513,'35':1.093,'50':0.800,'70':0.558,'95':0.403,'120':0.321,'150':0.262,'185':0.209,'240':0.161, '300': 0.128, '400': 0.102, '500': 0.084, '630': 0.067}
                    }
                },
                CABLE_REACTANCE: {
                    unipolar: {'1.5':0.08,'2.5':0.08,'4':0.08,'6':0.078,'10':0.136,'16':0.126,'25':0.117,'35':0.111,'50':0.106,'70':0.1,'95':0.095,'120':0.091,'150':0.086,'185':0.083,'240':0.081, '300': 0.083, '400': 0.081, '500': 0.080, '630': 0.079},
                    tripolar: {'1.5':0.08,'2.5':0.08,'4':0.08,'6':0.078,'10':0.115,'16':0.107,'25':0.1,'35':0.095,'50':0.091,'70':0.086,'95':0.083,'120':0.081,'150':0.079,'185':0.079,'240':0.076, '300': 0.075, '400': 0.074, '500': 0.073, '630': 0.072}
                },
                K_FACTOR_CC: { cobre: { pvc: 115, xlpe: 143 }, aluminio: { pvc: 76, xlpe: 94 }},
                KAPPA_TABLE: [{r:0,k:2},{r:0.1,k:1.86},{r:0.2,k:1.71},{r:0.3,k:1.57},{r:0.4,k:1.45},{r:0.5,k:1.35},{r:0.6,k:1.26},{r:0.7,k:1.19},{r:0.8,k:1.13},{r:0.9,k:1.08},{r:1,k:1.04},{r:1.1,k:1.02},{r:1.2,k:1.01}],
                TRAFO_VALUES: [{ s: "25-160", ucc: 4, ur: "2.8-1.47" },{ s: "200-315", ucc: 4, ur: "1.4-1.23" },{ s: "400-630", ucc: 4, ur: "1.15-1.03" },{ s: "800-1250", ucc: 5, ur: "1.1-1.05" },{ s: "1600-2500", ucc: 6, ur: "1.0-1.05" }],
                ICONS: {
                    TRANSFORMER: `<svg class="diagram-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" stroke-width="3" stroke="var(--line-color)" fill="none"><circle cx="32" cy="22" r="12"/><circle cx="32" cy="42" r="12"/></svg>`,
                    MOTOR: `<svg class="diagram-icon" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g stroke-width="3" stroke="var(--line-color)" fill="none"><circle cx="32" cy="32" r="18"/><text x="25" y="42" font-family="Arial" font-size="24" font-weight="bold" fill="var(--line-color)">M</text></g></svg>`,
                    SWITCH: `<svg class="diagram-icon" style="height:28px" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg"><g stroke="var(--line-color)" stroke-width="2.5"><line x1="32" y1="0" x2="32" y2="26"/><line x1="32" y1="38" x2="32" y2="64"/><line x1="22" y1="38" x2="42" y2="26"/></g></svg>`,
                    FAULT: `<svg class="diagram-fault-icon" viewBox="0 0 50 40"><path d="M5 20 L15 20 L20 10 L30 30 L35 20 L45 20" stroke="#ef4444" stroke-width="3" fill="none" stroke-linecap="round" stroke-linejoin="round"/><path d="M45 20 L40 15 M45 20 L40 25" stroke="#ef4444" stroke-width="3" fill="none" stroke-linecap="round"/></svg>`
                }
            };

            let exportData = [];
            const getById_sc = id => document.getElementById(id);

            function addFeederNode() {
                const container = getById_sc('transformerFeedersContainer');
                const count = container.children.length + 1;
                const id = `feeder-node-${Date.now()}`;
                const feederDiv = document.createElement('div');
                feederDiv.className = 'feeder-node';
                feederDiv.id = id;
                
                const mtSectionOptions = CONSTS.CABLE_SECTIONS.filter(s => parseFloat(s) >= 16).map(s => `<option value="${s}" ${s === "35" ? "selected" : ""}>${s} mm²</option>`).join('');

                feederDiv.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <input type="text" value="Alimentador a Trafo #${count}" class="node-name-input text-2xl text-purple-700 data-input">
                        <button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-2xl" data-target="${id}">&times;</button>
                    </div>
                    <div class="section-divider">
                        <h4 class="text-xl font-semibold mb-4 text-gray-700">2. Cable de Media Tensión</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                            <div class="input-group"><label>Longitud [m]</label><input type="number" value="50" class="cable-length-mt data-input" min="0"></div>
                            <div class="input-group"><label>Sección</label><select class="cable-section-area-mt data-input">${mtSectionOptions}</select></div>
                            <div class="input-group"><label>Material</label><select class="cable-material-mt data-input"><option value="cobre" selected>Cobre</option><option value="aluminio">Aluminio</option></select></div>
                            <div class="input-group"><label>Tipo</label><select class="cable-type-mt data-input"><option value="tripolar" selected>Tripolar</option><option value="unipolar">3 Unipolares</option></select></div>
                        </div>
                    </div>
                    <div class="section-divider">
                        <h4 class="text-xl font-semibold mb-4 text-gray-800">3. Transformador MT/BT</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-x-4">
                            <div class="input-group"><label>Potencia [kVA]</label><input type="number" value="630" min="1" class="power data-input"></div>
                            <div class="input-group"><label>Tensión Sec. [V]</label><input type="number" value="400" min="1" class="voltage data-input"></div>
                            <div class="input-group"><label>Ucc (%)</label><input type="number" value="4" min="0.1" step="any" class="impedance data-input"></div>
                            <div class="input-group"><label>Ur (%)</label><input type="number" value="1.1" min="0.1" step="any" class="ur_percent data-input"></div>
                        </div>
                    </div>
                    <div>
                        <h4 class="text-xl font-semibold mb-4 text-gray-800">4. Estructura de Circuitos en BT</h4>
                        <div class="circuitTreeContainer"></div>
                        <div class="mt-4">
                            <button type="button" class="add-trunk-btn btn btn-sm bg-blue-600 hover:bg-blue-700 text-white w-full">Agregar Troncal BT</button>
                        </div>
                    </div>
                `;
                container.appendChild(feederDiv);
                calculateAndDisplaySC();
            }

            function addCableNode(container) {
                const id = `cable-node-${Date.now()}`;
                const nodeDiv = document.createElement('div');
                nodeDiv.className = 'cable-node';
                nodeDiv.id = id;

                const title = container.classList.contains('circuitTreeContainer') ? `Troncal BT #${container.children.length + 1}` : `Derivación #${container.children.length + 1}`;
                let sectionOptions = CONSTS.CABLE_SECTIONS.map(s => `<option value="${s}" ${s === "95" ? "selected" : ""}>${s} mm²</option>`).join('');
                
                nodeDiv.innerHTML = `
                    <div class="node-content">
                        <div class="flex justify-between items-center mb-4"><input type="text" value="${title}" class="node-name-input font-semibold text-gray-800 data-input"><button type="button" class="remove-btn text-red-500 hover:text-red-700 font-bold text-2xl" data-target="${id}">&times;</button></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-x-4">
                            <div class="input-group"><label>Sección</label><select class="cable-section-area-sc data-input">${sectionOptions}</select></div>
                            <div class="input-group"><label>Longitud [m]</label><input type="number" value="20" min="0" class="cable-length-sc data-input"></div>
                            <div class="input-group"><label>Material</label><select class="cable-material-sc data-input"><option value="cobre" selected>Cobre</option><option value="aluminio">Aluminio</option></select></div>
                            <div class="input-group"><label>Aislación</label><select class="cable-insulation-sc data-input"><option value="xlpe" selected>XLPE</option><option value="pvc">PVC</option></select></div>
                            <div class="input-group"><label>Tipo</label><select class="cable-type-sc data-input"><option value="tripolar" selected>Tripolar</option><option value="unipolar">3 Unipolares</option></select></div>
                            <div class="input-group"><label>Tiempo Despeje [s]</label><input type="number" value="0.1" min="0.01" step="0.01" class="protection-time-sc data-input"></div>
                            <div class="input-group"><label>Norma Cable</label><select class="cable-standard-sc data-input"><option value="2178" selected>IRAM 2178</option><option value="247">IRAM 247-3</option></select></div>
                            <div class="input-group"><label>Tipo de Tendido</label><select class="cable-install-sc data-input"><option value="B1">B1</option><option value="B2" selected>B2</option><option value="C">C</option><option value="E">E</option><option value="F">F</option><option value="G">G</option></select></div>
                        </div>
                        <div class="mt-2 p-3 bg-indigo-50 rounded-lg">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" class="motor-contribution-cb data-input form-checkbox h-5 w-5 text-indigo-600">
                                    <span class="text-sm font-medium text-gray-700">Aporte de Motor al CC</span>
                                </label>
                            <div class="motor-input-container hidden mt-2">
                                <div class="input-group !mb-0"><label>In Motor [A]</label><input type="number" value="100" min="0" class="motor-in-sc data-input"></div>
                            </div>
                        </div>
                    </div>
                    <div class="node-actions"><button type="button" class="add-branch-btn btn btn-sm bg-indigo-600 hover:bg-indigo-700 text-white">Agregar Derivación</button></div>
                    <div class="children-container"></div>
                `;
                container.appendChild(nodeDiv);
                calculateAndDisplaySC();
            }

            function calculateAndDisplaySC() {
                let calculationLog = [];
                const resultsContent = getById_sc('resultsContentSC');
                resultsContent.innerHTML = '';
                exportData = [];

                const Scc_red_mva = parseFloat(getById_sc('sccRed').value) || 0;
                const U_red_kv = parseFloat(getById_sc('tensionRed').value) || 0;
                
                if (!Scc_red_mva || !U_red_kv || getById_sc('transformerFeedersContainer').children.length === 0) {
                    getById_sc('resultsPlaceholderSC').style.display = 'block';
                    resultsContent.style.display = 'none';
                    if (getById_sc('diagramCard')) getById_sc('diagramCard').style.display = 'none';
                    displayCalculationLog([]);
                    return;
                }
                
                getById_sc('resultsPlaceholderSC').style.display = 'none';
                resultsContent.style.display = 'block';
                if (getById_sc('diagramCard')) getById_sc('diagramCard').style.display = 'block';

                const Z_red_ohm = (1.1 * U_red_kv ** 2) / Scc_red_mva;
                const X_red_ohm = Z_red_ohm / 1.005; 
                const R_red_ohm = X_red_ohm * 0.1;
                addSCResult("Acometida de Red (MT)", U_red_kv * 1000, R_red_ohm, X_red_ohm);
                calculationLog.push(`<strong>1. Acometida MT:</strong> Z_red = (1.1 * ${U_red_kv}² kV) / ${Scc_red_mva} MVA = ${Z_red_ohm.toFixed(5)} Ω`);
                
                document.querySelectorAll('.feeder-node').forEach((feederNode, index) => {
                    const feederName = feederNode.querySelector('.node-name-input').value || `Alimentador #${index + 1}`;
                    calculationLog.push(`<strong class="text-purple-700 mt-4 block border-t pt-4">--- INICIO CÁLCULO ${feederName.toUpperCase()} ---</strong>`);
                    
                    const S_tr_kva = parseFloat(feederNode.querySelector('.power').value) || 0;
                    const U_tr_v = parseFloat(feederNode.querySelector('.voltage').value) || 0;
                    const Zcc_tr_percent = parseFloat(feederNode.querySelector('.impedance').value) || 0;
                    const Ur_tr_percent = parseFloat(feederNode.querySelector('.ur_percent').value) || 0;

                    if (!S_tr_kva || !U_tr_v || !Zcc_tr_percent || !Ur_tr_percent) return;

                    let R_cable_mt = 0, X_cable_mt = 0;
                    const length_mt_m = parseFloat(feederNode.querySelector('.cable-length-mt').value) || 0;
                    if (length_mt_m > 0) {
                        const area_mt = feederNode.querySelector('.cable-section-area-mt').value;
                        const type_mt = feederNode.querySelector('.cable-type-mt').value;
                        const material_mt = feederNode.querySelector('.cable-material-mt').value;
                        const insulation_mt = "xlpe"; // Se asume XLPE para MT
                        const r_km = CONSTS.CABLE_RESISTANCE[material_mt]?.[insulation_mt]?.[area_mt] || 0;
                        const x_km = CONSTS.CABLE_REACTANCE[type_mt]?.[area_mt] || 0;
                        R_cable_mt = r_km * (length_mt_m / 1000);
                        X_cable_mt = x_km * (length_mt_m / 1000);
                    }
                    calculationLog.push(`<strong>2. Cable MT (${feederName}):</strong> R=${R_cable_mt.toFixed(5)}, X=${X_cable_mt.toFixed(5)}`);
                    
                    const R_total_mt = R_red_ohm + R_cable_mt;
                    const X_total_mt = X_red_ohm + X_cable_mt;
                    addSCResult(`${feederName} - Bornes MT Trafo`, U_red_kv * 1000, R_total_mt, X_total_mt);
                    
                    const transform_ratio = (U_red_kv * 1000) / U_tr_v;
                    const R_mt_ref_bt = R_total_mt / (transform_ratio ** 2);
                    const X_mt_ref_bt = X_total_mt / (transform_ratio ** 2);
                    calculationLog.push(`<strong>3. Ref. a BT (${feederName}):</strong> R_ref = ${R_total_mt.toFixed(5)} / ${transform_ratio.toFixed(2)}² = ${R_mt_ref_bt.toFixed(5)}`);
                    
                    const R_tr_ohm = (Ur_tr_percent / 100) * (U_tr_v ** 2) / (S_tr_kva * 1000);
                    const Ux_tr_percent = Math.sqrt(Math.max(0, Zcc_tr_percent**2 - Ur_tr_percent**2));
                    const X_tr_ohm = (Ux_tr_percent / 100) * (U_tr_v ** 2) / (S_tr_kva * 1000);
                    calculationLog.push(`<strong>4. Impedancia Trafo (${feederName}):</strong> R_tr=${R_tr_ohm.toFixed(5)}, X_tr=${X_tr_ohm.toFixed(5)}`);

                    const R_base_bt = R_mt_ref_bt + R_tr_ohm;
                    const X_base_bt = X_mt_ref_bt + X_tr_ohm;
                    addSCResult(`${feederName} - Bornes BT Trafo`, U_tr_v, R_base_bt, X_base_bt);
                    calculationLog.push(`<strong>5. Total en Bornes BT (${feederName}):</strong> R_total=${R_base_bt.toFixed(5)}, X_total=${X_base_bt.toFixed(5)}`);
                    
                    feederNode.querySelector('.circuitTreeContainer').querySelectorAll(':scope > .cable-node').forEach((node) => {
                        recursiveCalculate(node, `${feederName} @ Bornes BT`, R_base_bt, X_base_bt, calculationLog, U_tr_v);
                    });
                });
                displayCalculationLog(calculationLog);
                drawDiagram();
            }
            
            function recursiveCalculate(nodeElement, parentName, parentR, parentX, log, voltage) {
                const area = nodeElement.querySelector('.cable-section-area-sc').value;
                const length_m = parseFloat(nodeElement.querySelector('.cable-length-sc').value) || 0;
                const material = nodeElement.querySelector('.cable-material-sc').value;
                const insulation = nodeElement.querySelector('.cable-insulation-sc').value;
                const type = nodeElement.querySelector('.cable-type-sc').value;
                const t = parseFloat(nodeElement.querySelector('.protection-time-sc').value) || 0.1;

                const r_km = CONSTS.CABLE_RESISTANCE[material]?.[insulation]?.[area] || 0;
                const x_km = CONSTS.CABLE_REACTANCE[type]?.[area] || 0;
                const R_cable = r_km * (length_m / 1000);
                const X_cable = x_km * (length_m / 1000);

                const R_total_at_node = parentR + R_cable;
                const X_total_at_node = parentX + X_cable;
                const Z_total = Math.sqrt(R_total_at_node**2 + X_total_at_node**2);
                const Icc_source = Z_total > 0 ? (voltage / (Math.sqrt(3) * Z_total)) : 0;
                
                let Icc_from_downstream_motors = 0;
                const motorCb = nodeElement.querySelector('.motor-contribution-cb');
                if (motorCb && motorCb.checked) {
                    const motorIn = parseFloat(nodeElement.querySelector('.motor-in-sc').value) || 0;
                    Icc_from_downstream_motors += motorIn * 5;
                }

                const childrenContainer = nodeElement.querySelector('.children-container');
                childrenContainer.querySelectorAll(':scope > .cable-node').forEach((childNode) => {
                    Icc_from_downstream_motors += recursiveCalculate(childNode, nodeElement.querySelector('.node-name-input').value, R_total_at_node, X_total_at_node, log, voltage);
                });
                
                const Icc_total_through_cable = Icc_source + Icc_from_downstream_motors;

                const k_icc = CONSTS.K_FACTOR_CC[material]?.[insulation] || 0;
                const I_adm_cc = (k_icc * parseFloat(area)) / Math.sqrt(t);
                const passes = I_adm_cc >= Icc_total_through_cable;

                const sectionSelect = nodeElement.querySelector('.cable-section-area-sc');
                sectionSelect.classList.toggle('input-error', !passes);

                const nodeTitle = nodeElement.querySelector('.node-name-input').value;
                const pointName = `${parentName} → ${nodeTitle}`;

                addSCResult(pointName, voltage, R_total_at_node, X_total_at_node, { 
                    I_adm_cc, Icc_source, Icc_motor: Icc_from_downstream_motors, Icc_total: Icc_total_through_cable, passes 
                });
                log.push(`<strong>Punto ${nodeTitle}:</strong> R_cable=${R_cable.toFixed(5)}, X_cable=${X_cable.toFixed(5)}<br>↳ R_total=${R_total_at_node.toFixed(5)}, X_total=${X_total_at_node.toFixed(5)}`);
                
                return Icc_from_downstream_motors;
            }

            function addSCResult(pointName, voltage_v, R_total, X_total, verification) {
                const Z_total = Math.sqrt(R_total**2 + X_total**2);
                const Icc_source = verification ? verification.Icc_source : (Z_total > 0 ? (voltage_v / (Math.sqrt(3) * Z_total)) : 0);
                const ratio_RX = X_total > 0 ? (R_total / X_total) : 0;
                const kappa = getKappaFactor(ratio_RX);
                const Is = kappa * Math.sqrt(2) * Icc_source;

                let verificationHTML = '';
                if (verification) {
                    const { I_adm_cc, Icc_motor, Icc_total, passes } = verification;
                    const resultClass = passes ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    verificationHTML = `
                        <div class="result-item text-sm"><span>Icc Aporte Red:</span><span class="font-bold">${(Icc_source / 1000).toFixed(2)} kA</span></div>
                        <div class="result-item text-sm"><span>Icc Aporte Motores:</span><span class="font-bold">${(Icc_motor / 1000).toFixed(2)} kA</span></div>
                        <div class="result-item"><span>Icc Total (para verificación):</span><span class="font-bold text-lg text-blue-600">${(Icc_total / 1000).toFixed(2)} kA</span></div>
                        <div class="mt-4 p-3 rounded-lg text-center font-bold text-lg ${resultClass}">
                            Verificación por Cortocircuito (Efecto Térmico): ${passes ? 'VERIFICA' : 'NO VERIFICA'}
                        </div>
                        <div class="text-xs text-center mt-1 text-gray-600">
                            Iadm_cc: ${(I_adm_cc / 1000).toFixed(2)} kA vs. Icc Total: ${(Icc_total / 1000).toFixed(2)} kA
                        </div>
                    `;
                }

                const resultDiv = document.createElement('div');
                resultDiv.className = 'result-card';
                resultDiv.innerHTML = `<h4 class="text-lg font-semibold text-indigo-600 mb-3">${pointName}</h4>
                    <div class="result-item"><span>Icc en Punto (aporte red):</span><span class="font-bold text-xl text-red-600">${(Icc_source / 1000).toFixed(2)} kA</span></div>
                    <div class="result-item"><span>Corriente de Impulso (Is):</span><span class="font-bold text-xl text-purple-600">${(Is / 1000).toFixed(2)} kA</span></div>
                    ${verificationHTML}
                    <details class="mt-2 text-sm"><summary>Ver detalles de impedancia</summary><div class="log-box">Z_total: ${Z_total.toFixed(5)} Ω<br>R_total: ${R_total.toFixed(5)} Ω<br>X_total: ${X_total.toFixed(5)} Ω<br>R/X: ${ratio_RX.toFixed(3)}<br>Factor χ: ${kappa.toFixed(3)}</div></details>`;
                getById_sc('resultsContentSC').appendChild(resultDiv);
                
                exportData.push({
                    pointName, icc_source: (Icc_source / 1000).toFixed(2), is: (Is / 1000).toFixed(2), z: Z_total.toFixed(5), r: R_total.toFixed(5), x: X_total.toFixed(5), rx: ratio_RX.toFixed(3), kappa: kappa.toFixed(3), i_adm_cc: verification ? (verification.I_adm_cc/1000).toFixed(2) : 'N/A', icc_motor: verification ? (verification.Icc_motor/1000).toFixed(2) : 'N/A', icc_total: verification ? (verification.Icc_total/1000).toFixed(2) : 'N/A', verifica: verification ? (verification.passes ? 'SI' : 'NO') : 'N/A' 
                });
            }
            
            function displayCalculationLog(log) {
                const container = getById_sc('calculationLogContainer');
                container.innerHTML = log.length ? log.map(e => `<div class="calculation-log-entry">${e}</div>`).join('') : '<p class="text-gray-500 p-4 text-center">El detalle del cálculo aparecerá aquí.</p>';
            }

            function getKappaFactor(ratio) {
                if (isNaN(ratio)) return 1.0; const table = CONSTS.KAPPA_TABLE; if (ratio <= table[0].r) return table[0].k; if (ratio >= table[table.length - 1].r) return 1.0;
                for (let i = 0; i < table.length - 1; i++) { if (ratio >= table[i].r && ratio < table[i+1].r) { const l = table[i], u = table[i+1]; return l.k + ((ratio - l.r) / (u.r - l.r)) * (u.k - l.k); } } return 1.0;
            }

            function populateAnnexTables() {
                const createTable = (data, headers) => `<thead><tr>${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(row => `<tr>${Object.values(row).map(cell => `<td>${cell}</td>`).join('')}</tr>`).join('')}</tbody>`;
                if(getById_sc('kappaTable')) getById_sc('kappaTable').innerHTML = createTable(CONSTS.KAPPA_TABLE, ['R/X', 'Factor χ']);
                if(getById_sc('trafoTable')) getById_sc('trafoTable').innerHTML = createTable(CONSTS.TRAFO_VALUES, ['S [kVA]', 'Ucc [%]', 'Ur [%]']);
            }
            
            function drawDiagram() {
                const diagramContainer = getById_sc('diagramContainer');
                diagramContainer.innerHTML = ''; 
                diagramContainer.className = 'diagram-container';

                const busbarMT = document.createElement('div');
                busbarMT.className = 'diagram-bus';
                diagramContainer.appendChild(busbarMT);
                
                const feedersContainer = document.createElement('div');
                feedersContainer.className = 'diagram-children-wrapper';
                diagramContainer.appendChild(feedersContainer);

                document.querySelectorAll('.feeder-node').forEach(feederNode => {
                    const feederBranch = document.createElement('div');
                    feederBranch.className = 'diagram-branch';
                    feedersContainer.appendChild(feederBranch);

                    const switchWrapper = document.createElement('div');
                    switchWrapper.className = 'diagram-icon-wrapper';
                    switchWrapper.innerHTML = `<div class="diagram-line-through"></div><div class="diagram-icon">${CONSTS.ICONS.SWITCH}</div>`;
                    feederBranch.appendChild(switchWrapper);
                    
                    const length_mt_m = feederNode.querySelector('.cable-length-mt').value;
                    if (length_mt_m > 0) {
                        const cableSegment = document.createElement('div');
                        cableSegment.className = 'diagram-icon-wrapper';
                        cableSegment.innerHTML = `<div class="diagram-line-through"></div><span class="diagram-label">Cable MT</span>`;
                        feederBranch.appendChild(cableSegment);
                    }

                    const trafoPower = feederNode.querySelector('.power').value;
                    const trafoWrapper = document.createElement('div');
                    trafoWrapper.className = 'diagram-icon-wrapper';
                    trafoWrapper.innerHTML = `<div class="diagram-line-through"></div>
                                                    <div class="diagram-icon">${CONSTS.ICONS.TRANSFORMER}</div>
                                                    ${CONSTS.ICONS.FAULT}`;
                    feederBranch.appendChild(trafoWrapper);
                    feederBranch.innerHTML += `<span class="diagram-label">${trafoPower} kVA</span>`;
                    
                    feederBranch.innerHTML += `<div class="diagram-line" style="height: 20px;"></div>`;

                    const busbarBT = document.createElement('div');
                    busbarBT.className = 'diagram-bus';
                    feederBranch.appendChild(busbarBT);

                    const btTrunksContainer = document.createElement('div');
                    btTrunksContainer.className = 'diagram-children-wrapper';
                    feederBranch.appendChild(btTrunksContainer);

                    const circuitTreeContainer = feederNode.querySelector('.circuitTreeContainer');
                    circuitTreeContainer.querySelectorAll(':scope > .cable-node').forEach(node => {
                        recursiveDrawNode(node, btTrunksContainer);
                    });
                });
            }

            function recursiveDrawNode(nodeElement, parentDiagramContainer) {
                const branchContainer = document.createElement('div');
                branchContainer.className = 'diagram-branch';
                parentDiagramContainer.appendChild(branchContainer);

                branchContainer.innerHTML += `<div class="diagram-line" style="height: 20px;"></div>`;
                
                const switchWrapper = document.createElement('div');
                switchWrapper.className = 'diagram-icon-wrapper';
                switchWrapper.innerHTML = `<div class="diagram-line-through"></div><div class="diagram-icon">${CONSTS.ICONS.SWITCH}</div>`;
                branchContainer.appendChild(switchWrapper);
                
                const cableName = nodeElement.querySelector('.node-name-input').value;
                
                const cableSegment = document.createElement('div');
                cableSegment.className = 'diagram-icon-wrapper';
                cableSegment.innerHTML = `
                    <div class="diagram-line-through"></div>
                    <div class="flex items-center">
                        <span class="diagram-label">${cableName}</span>
                        ${CONSTS.ICONS.FAULT}
                    </div>
                `;
                branchContainer.appendChild(cableSegment);

                const childrenContainer = nodeElement.querySelector('.children-container');
                const childrenNodes = childrenContainer.querySelectorAll(':scope > .cable-node');
                const isMotorLoad = nodeElement.querySelector('.motor-contribution-cb').checked;

                if (childrenNodes.length > 0) {
                    branchContainer.innerHTML += `<div class="diagram-line" style="height: 20px;"></div>`;
                    const busbar = document.createElement('div');
                    busbar.className = 'diagram-bus';
                    branchContainer.appendChild(busbar);

                    const newParentContainer = document.createElement('div');
                    newParentContainer.className = 'diagram-children-wrapper';
                    branchContainer.appendChild(newParentContainer);

                    childrenNodes.forEach(childNode => {
                        recursiveDrawNode(childNode, newParentContainer);
                    });
                } else if (isMotorLoad) {
                    branchContainer.innerHTML += `<div class="diagram-line" style="height: 20px;"></div>`;
                    const motorWrapper = document.createElement('div');
                    motorWrapper.className = 'diagram-icon-wrapper';
                    motorWrapper.innerHTML = `<div class="diagram-line-through"></div><div class="diagram-icon">${CONSTS.ICONS.MOTOR}</div>`;
                    branchContainer.appendChild(motorWrapper);
                }
            }

            function handleExportSC() {
                if (exportData.length === 0) { alert("No hay datos para exportar."); return; }
                const headers = ["Punto de Falla", "Icc Red (kA)", "Icc Motores (kA)", "Icc Total Verif. (kA)", "Is (kA)", "Iadm_cc (kA)", "Verifica Icc?", "Z_total (Ω)", "R_total (Ω)", "X_total (Ω)", "R/X", "Factor χ"];
                const rows = [headers, ...exportData.map(d => [d.pointName, d.icc_source, d.icc_motor, d.icc_total, d.is, d.i_adm_cc, d.verifica, d.z, d.r, d.x, d.rx, d.kappa])];
                const processRow = row => row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(';');
                const csvContent = "data:text/csv;charset=utf-8," + rows.map(processRow).join('\n');
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI(csvContent));
                link.setAttribute("download", 'resultados_cortocircuito.csv');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            function handleExportWord() {
                if (exportData.length === 0) { alert("No hay datos para exportar."); return; }
                let html = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>";
                html += "<head><meta charset='utf-8'><title>Resultados de Cortocircuito</title>";
                html += "<style> body{font-family: Arial, sans-serif;} table, th, td { border: 1px solid black; border-collapse: collapse; padding: 5px; text-align: center;} th { background-color: #f2f2f2; } </style>";
                html += "</head><body>";
                html += "<h1>Resultados del Cálculo de Cortocircuito</h1>";
                html += "<table width='100%'><thead><tr>";
                const headers = ["Punto", "Icc Red (kA)", "Icc Motores (kA)", "Icc Total (kA)", "Is (kA)", "Iadm_cc (kA)", "Verifica?", "Z (Ω)", "R (Ω)", "X (Ω)"];
                headers.forEach(h => html += `<th>${h}</th>`);
                html += "</tr></thead><tbody>";
                exportData.forEach(d => {
                    html += `<tr>
                                <td>${d.pointName}</td>
                                <td>${d.icc_source}</td>
                                <td>${d.icc_motor}</td>
                                <td>${d.icc_total}</td>
                                <td>${d.is}</td>
                                <td>${d.i_adm_cc}</td>
                                <td style="background-color:${d.verifica === 'SI' ? '#dcfce7' : '#fee2e2'};">${d.verifica}</td>
                                <td>${d.z}</td>
                                <td>${d.r}</td>
                                <td>${d.x}</td>
                            </tr>`;
                });
                html += "</tbody></table></body></html>";
                
                const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
                const url = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(html);
                const downloadLink = document.createElement("a");
                document.body.appendChild(downloadLink);
                downloadLink.href = url;
                downloadLink.download = 'resultados_cortocircuito.doc';
                downloadLink.click();
                document.body.removeChild(downloadLink);
            }

            function init_sc() {
                populateAnnexTables();
                getById_sc('addFeederBtn').addEventListener('click', addFeederNode);
                getById_sc('resetButtonSC').addEventListener('click', () => {
                    getById_sc('transformerFeedersContainer').innerHTML = '';
                    calculateAndDisplaySC();
                });
                getById_sc('exportSCBtn').addEventListener('click', handleExportSC);
                getById_sc('exportWordBtn').addEventListener('click', handleExportWord);
                
                getById_sc('shortCircuitForm').addEventListener('input', e => {
                    if (e.target.classList.contains('data-input')) {
                            if (e.target.type === 'checkbox' && e.target.classList.contains('motor-contribution-cb')) {
                                const container = e.target.closest('.node-content').querySelector('.motor-input-container');
                                container.classList.toggle('hidden', !e.target.checked);
                            }
                        calculateAndDisplaySC();
                    }
                });
                
                getById_sc('shortCircuitForm').addEventListener('click', e => {
                    if (e.target.classList.contains('remove-btn')) {
                        getById_sc(e.target.dataset.target)?.remove();
                        calculateAndDisplaySC();
                    } else if (e.target.classList.contains('add-branch-btn')) {
                        const parentNode = e.target.closest('.cable-node');
                        const childrenContainer = parentNode.querySelector('.children-container');
                        addCableNode(childrenContainer);
                    } else if (e.target.classList.contains('add-trunk-btn')) {
                            const feederNode = e.target.closest('.feeder-node');
                            const container = feederNode.querySelector('.circuitTreeContainer');
                            addCableNode(container);
                    }
                });

                // Eventos para el modal del diagrama
                const diagramModal = getById_sc('diagramModal');
                getById_sc('fullscreenDiagramBtn').addEventListener('click', () => {
                    getById_sc('diagramModalContent').innerHTML = getById_sc('diagramContainer').outerHTML;
                    diagramModal.style.display = 'flex';
                });
                getById_sc('closeDiagramModal').addEventListener('click', () => {
                    diagramModal.style.display = 'none';
                });
                diagramModal.addEventListener('click', (e) => {
                    if (e.target === diagramModal) {
                        diagramModal.style.display = 'none';
                    }
                });

                calculateAndDisplaySC();
            }
            
            init_sc();
        })();

    });
    </script>
</body>
</html>
