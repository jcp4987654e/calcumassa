<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Calculadoras Técnicas Eléctricas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --header-bg:#0E3A8A;
      --primary-color:#3B82F6;
      --nav-bg:#1F2937;
      --nav-active:var(--primary-color);
      --body-bg:#F3F4F6;
      --card-bg:#FFFFFF;
      --text-primary:#111827;
      --text-secondary:#4B5563;
      --border-color:#E5E7EB;
    }
    [data-theme="dark"] {
      --header-bg:#0F172A;
      --primary-color:#60A5FA;
      --nav-bg:#111827;
      --nav-active:#60A5FA;
      --body-bg:#0B1220;
      --card-bg:#0F172A;
      --text-primary:#E5E7EB;
      --text-secondary:#9CA3AF;
      --border-color:#1F2937;
    }
    body{font-family:'Inter',sans-serif;background:var(--body-bg);color:var(--text-primary);}
    .container{max-width:1100px;margin-inline:auto;padding:1rem;}
    .card{background:var(--card-bg);border:1px solid var(--border-color);box-shadow:0 1px 2px rgba(0,0,0,.04);border-radius:1rem;}
    .h1{font-size:1.75rem;line-height:1.2;font-weight:700;margin:0;}
    .h2{font-size:1.25rem;line-height:1.3;font-weight:600;margin:0;}
    .muted{color:var(--text-secondary);}
    .btn{display:inline-flex;align-items:center;gap:.5rem;border:1px solid var(--border-color);border-radius:.75rem;padding:.6rem .9rem;background:#fff;}
    .btn-primary{background:var(--primary-color);color:#fff;border-color:transparent;}
    .btn-ghost{background:transparent;}
    nav a{color:#E5E7EB;padding:.5rem .75rem;border-radius:.5rem;}
    nav a.active{background:rgba(255,255,255,.08);color:var(--nav-active);}
    @media print {
      header, nav, .fab, .no-print { display:none !important; }
      body{background:#fff;}
      .card{box-shadow:none !important;border:1px solid #ddd;}
      .print-block{display:block !important;}
    }
  </style>
</head>
<body>
  <header class="w-full" style="background:var(--header-bg)">
    <div class="container py-8 text-white">
      <h1 class="h1">Calculadoras Técnicas Eléctricas</h1>
      <p class="muted mt-1">Cables, secciones, puesta a tierra y más — con memoria de cálculo imprimible.</p>
    </div>
  </header>

  <nav class="w-full sticky top-0 z-30" style="background:var(--nav-bg)">
    <div class="container flex gap-2 py-3">
      <a href="#inicio" class="active" data-link>Inicio</a>
      <a href="#tierra" data-link>Puesta a Tierra</a>
      <a href="#cables" data-link>Cálculo de Cables</a>
      <a href="#cortocircuito" data-link>Cortocircuito</a>
      <a href="#reportes" data-link>Reportes</a>
    </div>
  </nav>

  <main class="container space-y-6">
    <!-- INICIO -->
    <section id="inicio" class="card p-6">
      <h2 class="h2">Bienvenido</h2>
      <p class="muted mt-2">Elegí una calculadora en el menú. Podés exportar resultados como CSV/TXT o imprimir una “Memoria de cálculo”.</p>
    </section>

    <!-- PUESTA A TIERRA -->
    <section id="tierra" class="card p-6 hidden">
      <div class="flex items-center justify-between gap-3">
        <h2 class="h2">Puesta a Tierra</h2>
        <div class="flex gap-2">
          <button id="tierraCalcBtn" class="btn btn-primary">Verificar Puesta a Tierra</button>
          <button id="tierraCsvBtn" class="btn">CSV</button>
          <button id="tierraTxtBtn" class="btn">TXT</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="p-4 card">
          <p class="muted mb-3">Parámetros (TT, AEA)</p>
          <label class="block text-sm mb-2">Resistividad del terreno (Ω·m)
            <input id="pat_resistividad" type="number" step="0.01" class="w-full mt-1 rounded border px-3 py-2" placeholder="100">
          </label>
          <label class="block text-sm mb-2">Longitud de jabalina (m)
            <input id="pat_longitud" type="number" step="0.01" class="w-full mt-1 rounded border px-3 py-2" placeholder="2.4">
          </label>
          <label class="block text-sm mb-2">Diámetro de jabalina (m)
            <input id="pat_diametro" type="number" step="0.001" class="w-full mt-1 rounded border px-3 py-2" placeholder="0.016">
          </label>
          
          <label class="block text-sm mb-2">Interruptor diferencial IΔn (A)
            <input id="pat_idn" type="number" step="0.005" class="w-full mt-1 rounded border px-3 py-2" placeholder="0.03">
          </label>
          <label class="block text-sm mb-2">Tensión de contacto admisible U<sub>L</sub> (V)
            <select id="pat_ul" class="w-full mt-1 rounded border px-3 py-2">
              <option value="50" selected>50 V (condiciones normales)</option>
              <option value="25">25 V (locales especiales)</option>
            </select>
          </label>

          <label class="block text-sm mb-2">Número de jabalinas
            <input id="pat_n" type="number" step="1" class="w-full mt-1 rounded border px-3 py-2" placeholder="1">
          </label>
        </div>
        <div class="p-4 card">
          <p class="muted mb-3">Resultado</p>
          <div id="tierraResultado" class="rounded border p-3 bg-white"></div>
        </div>
      </div>

      <div id="tierraMemoria" class="print-block hidden mt-6 p-6 card">
        <h3 class="h2">Memoria de cálculo — Puesta a Tierra</h3>
        <div id="tierraMemoriaBody" class="mt-3 text-sm"></div>
      </div>
    </section>

    <!-- CABLES (mock básico para estructura) -->
    <section id="cables" class="card p-6 hidden">
      <div class="flex items-center justify-between gap-3">
        <h2 class="h2">Cálculo de Cables</h2>
        <div class="flex gap-2">
          <button id="cablesCsvBtn" class="btn">CSV</button>
          <button id="cablesTxtBtn" class="btn">TXT</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="p-4 card">
          <p class="muted mb-3">Parámetros (caída de tensión AEA / IRAM)</p>
          
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="block text-sm">Fases
              <select id="c_fases" class="w-full mt-1 rounded border px-3 py-2">
                <option value="mono">Monofásico</option>
                <option value="tri" selected>Trifásico</option>
              </select>
            </label>
            <label class="block text-sm">Modo de cálculo
              <select id="c_modo" class="w-full mt-1 rounded border px-3 py-2">
                <option value="tabla" selected>Tabla AEA (V/A·km)</option>
                <option value="rx">Cálculo por R/X</option>
              </select>
            </label>
            <label class="block text-sm">Norma / Tipo de cable
              <select id="c_norma" class="w-full mt-1 rounded border px-3 py-2">
                <option value="NM2473_cu" selected>IRAM NM 247-3 (Cu)</option>
                <option value="IRAM2178_cu">IRAM 2178 (Cu, 0.6/1 kV)</option>
                <option value="IRAM2178_al">IRAM 2178 (Al, 0.6/1 kV)</option>
              </select>
            </label>
            <label class="block text-sm">Disposición (unipolares)
              <select id="c_disp" class="w-full mt-1 rounded border px-3 py-2">
                <option value="multipolar" selected>Multipolar</option>
                <option value="trefoil">Trébol (tresbolillo)</option>
                <option value="plano">Plano</option>
              </select>
            </label>
            <label class="block text-sm">cos φ
              <input id="c_cosfi" type="number" min="0" max="1" step="0.01" value="0.8" class="w-full mt-1 rounded border px-3 py-2" />
            </label>
            <label class="block text-sm">sen φ
              <input id="c_senfi" type="number" min="0" max="1" step="0.01" value="0.6" class="w-full mt-1 rounded border px-3 py-2" />
            </label>
          </div>
          <div class="grid sm:grid-cols-2 gap-3 mt-3">
            <label class="block text-sm">Sección (mm²)
              <select id="c_sec" class="w-full mt-1 rounded border px-3 py-2"></select>
            </label>
            <label class="block text-sm">Límite de caída
              <select id="c_lim" class="w-full mt-1 rounded border px-3 py-2">
                <option value="3">3% (iluminación)</option>
                <option value="5" selected>5% (fuerza/TC)</option>
                <option value="custom">Personalizado…</option>
              </select>
            </label>
            <label class="block text-sm hidden" id="c_lim_custom_label">% Límite personalizado
              <input id="c_lim_custom" type="number" min="0" step="0.1" value="4" class="w-full mt-1 rounded border px-3 py-2" />
            </label>
            <label class="block text-sm">Override R/km (Ω/km)
              <input id="c_Rkm_override" type="number" step="0.0001" class="w-full mt-1 rounded border px-3 py-2" placeholder="auto"/>
            </label>
            <label class="block text-sm">Override X/km (Ω/km)
              <input id="c_Xkm_override" type="number" step="0.0001" class="w-full mt-1 rounded border px-3 py-2" placeholder="auto"/>
            </label>
          </div>
          <div class="mt-3">
            <button id="c_sugerir" class="btn btn-primary">Sugerir sección</button>
          </div>

          <label class="block text-sm mb-2">Corriente (A)
            <input id="c_i" type="number" step="0.1" class="w-full mt-1 rounded border px-3 py-2" placeholder="25">
          </label>
          <label class="block text-sm mb-2">Tensión (V)
            <input id="c_v" type="number" step="0.1" class="w-full mt-1 rounded border px-3 py-2" placeholder="220">
          </label>
          
          <label class="block text-sm mb-2">Sección (mm²)
            <select id="c_sec" class="w-full mt-1 rounded border px-3 py-2">
              <option value="1.5">1.5</option>
              <option value="2.5" selected>2.5</option>
              <option value="4">4</option>
              <option value="6">6</option>
              <option value="10">10</option>
              <option value="16">16</option>
              <option value="25">25</option>
              <option value="35">35</option>
              <option value="50">50</option>
              <option value="70">70</option>
              <option value="95">95</option>
              <option value="120">120</option>
            </select>
          </label>
          <label class="block text-sm mb-2">Uso
            <select id="c_uso" class="w-full mt-1 rounded border px-3 py-2">
              <option value="iluminacion">Iluminación (límite 3%)</option>
              <option value="fuerza" selected>Fuerza/TC (límite 5%)</option>
            </select>
          </label>

          <label class="block text-sm mb-2">Longitud (m)
            <input id="c_l" type="number" step="0.1" class="w-full mt-1 rounded border px-3 py-2" placeholder="30">
          </label>
        </div>
        <div class="p-4 card">
          <p class="muted mb-3">Resultado</p>
          <div id="cablesResultado" class="rounded border p-3 bg-white"></div>
        </div>
      </div>

      <div id="cablesMemoria" class="print-block hidden mt-6 p-6 card">
        <h3 class="h2">Memoria de cálculo — Cables</h3>
        <div id="cablesMemoriaBody" class="mt-3 text-sm"></div>
      </div>
    </section>

    
    <!-- CORTOCIRCUITO -->
    <section id="cortocircuito" class="card p-6 hidden">
      <div class="flex items-center justify-between gap-3">
        <h2 class="h2">Cortocircuito (MBT)</h2>
        <div class="flex gap-2">
          <button id="ccCsvBtn" class="btn">CSV</button>
          <button id="ccTxtBtn" class="btn">TXT</button>
        </div>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="p-4 card">
          <p class="muted mb-3">Parámetros</p>
          <label class="block text-sm mb-2">Tensión nominal V<sub>LL</sub> (V)
            <input id="cc_VLL" type="number" step="1" class="w-full mt-1 rounded border px-3 py-2" placeholder="380">
          </label>
          <label class="block text-sm mb-2">Esquema
            <select id="cc_esquema" class="w-full mt-1 rounded border px-3 py-2">
              <option value="trifasico">Trifásico</option>
              <option value="monofasico">Monofásico</option>
            </select>
          </label>
          <label class="block text-sm mb-2">Impedancia de fuente Z<sub>th</sub> (Ω) — magnitud
            <input id="cc_Zth" type="number" step="0.0001" class="w-full mt-1 rounded border px-3 py-2" placeholder="0.2">
          </label>
          <label class="block text-sm mb-2">Longitud del tramo (m)
            <input id="cc_L" type="number" step="0.1" class="w-full mt-1 rounded border px-3 py-2" placeholder="30">
          </label>
          <label class="block text-sm mb-2">Resistencia por km (Ω/km)
            <input id="cc_Rkm" type="number" step="0.01" class="w-full mt-1 rounded border px-3 py-2" placeholder="7.41">
          </label>
          <label class="block text-sm mb-2">Reactancia por km (Ω/km)
            <input id="cc_Xkm" type="number" step="0.01" class="w-full mt-1 rounded border px-3 py-2" placeholder="0.08">
          </label>
        </div>
        <div class="p-4 card">
          <p class="muted mb-3">Resultado</p>
          <div id="ccResultado" class="rounded border p-3 bg-white"></div>
          <div class="mt-4" id="ccSvg"></div>
        </div>
      </div>

      <div id="ccMemoria" class="print-block hidden mt-6 p-6 card">
        <h3 class="h2">Memoria de cálculo — Cortocircuito</h3>
        <div id="ccMemoriaBody" class="mt-3 text-sm"></div>
      </div>
    </section>
<!-- REPORTES -->
    <section id="reportes" class="card p-6 hidden">
      <h2 class="h2">Reportes y Exportaciones</h2>
      <p class="muted mt-2">Desde cada calculadora podés exportar CSV/TXT. Para PDF, usá el botón de impresión (🖨️) o Ctrl+P.</p>
    </section>
  </main>

  <!-- FABs -->
  <div class="fab fixed bottom-5 right-5 flex gap-2">
    <button id="printBtn" class="btn">🖨️</button>
    <button id="themeToggle" class="btn btn-ghost">🌓</button>
  </div>

  <!-- MÓDULOS JS (en un solo archivo para GitHub Pages) -->
  <script type="module">
    // ===================== utils/dom =====================
    const $ = (sel, root=document) => root.querySelector(sel);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const text = (el, value) => el && (el.textContent = value);

    function navigate(hash){
      $$("#main [id]").forEach(()=>{}); // noop placeholder
    }

    // ===================== utils/format =====================
    const fmt = {
      ohms: v => isFinite(v) ? new Intl.NumberFormat('es-AR',{maximumFractionDigits:2}).format(v) + " Ω" : "—",
      num: (v, d=2) => isFinite(v) ? new Intl.NumberFormat('es-AR',{maximumFractionDigits:d}).format(v) : "—"
    };

    // ===================== utils/files =====================
    function download(filename, content){
      const blob = new Blob([content], {type: "text/plain;charset=utf-8"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = filename;
      a.click();
      URL.revokeObjectURL(a.href);
    }
    function toCSV(rows){
      return rows.map(r => r.map(v => `"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n");
    }

    // ===================== router/nav =====================
    const links = $$("nav a[data-link]");
    const sections = ["inicio","tierra","cables","reportes"];
    function showSection(id){
      sections.forEach(s => {
        const el = document.getElementById(s);
        if (el) el.classList.toggle("hidden", s !== id);
        const l = links.find(a => a.getAttribute("href")==="#"+s);
        if (l) l.classList.toggle("active", s === id);
      });
      history.replaceState(null, "", "#"+id);
    }
    links.forEach(a => a.addEventListener("click", e => {
      e.preventDefault();
      const id = a.getAttribute("href").slice(1);
      showSection(id);
    }));
    showSection(location.hash?.slice(1) || "inicio");

    // ===================== theme =====================
    const root = document.documentElement;
    const saved = localStorage.getItem("theme") || (matchMedia("(prefers-color-scheme: dark)").matches ? "dark" : "light");
    if (saved === "dark") root.setAttribute("data-theme","dark");
    $("#themeToggle")?.addEventListener("click", () => {
      const isDark = root.getAttribute("data-theme")==="dark";
      if (isDark) root.removeAttribute("data-theme");
      else root.setAttribute("data-theme","dark");
      localStorage.setItem("theme", isDark ? "light" : "dark");
    });
    $("#printBtn")?.addEventListener("click", () => window.print());

    // ===================== domain/tierra =====================
    // Cálculo simplificado: resistencia de jabalinas en paralelo (aproximación) + chequeo objetivo R<=40Ω (ejemplo)
    function calculatePat({ resistividad, longitud, diametro, n }){
      // Resistencia de una jabalina: R = (ρ / (2πL)) * ln(4L/d)  (aprox)
      const L = Number(longitud);
      const d = Number(diametro);
      const rho = Number(resistividad);
      const one = (rho / (2*Math.PI*L)) * Math.log(4*L/d);
      const Req = one / Number(n || 1); // paralelo ideal (aprox)
      const objetivo = 40; // Ω (puede parametrizarse)
      return { R_unit: one, R_eq: Req, cumple: Req <= objetivo, objetivo };
    }

    function tierraParams(){
      return {
        resistividad: Number($("#pat_resistividad")?.value || 100),
        longitud: Number($("#pat_longitud")?.value || 2.4),
        diametro: Number($("#pat_diametro")?.value || 0.016),
        n: Number($("#pat_n")?.value || 1),
      };
    }

    function renderTierra(){
      const p = tierraParams();
      const r = calculatePat(p);
      const out = $("#tierraResultado");
      if (!out) return;
      out.innerHTML = `
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <div class="text-sm muted">R (una jabalina)</div>
            <div class="font-semibold">${fmt.ohms(r.R_unit)}</div>
          </div>
          <div>
            <div class="text-sm muted">R (equivalente)</div>
            <div class="font-semibold">${fmt.ohms(r.R_eq)}</div>
          </div>
          <div>
            <div class="text-sm muted">Objetivo</div>
            <div class="font-semibold">${fmt.ohms(r.objetivo)}</div>
          </div>
          <div>
            <div class="text-sm muted">¿Cumple?</div>
            <div class="font-semibold">${r.cumple ? "Sí ✅" : "No ❌"}</div>
          </div>
        </div>
      `;

      // Memoria de cálculo (se imprime en PDF)
      const body = $("#tierraMemoriaBody");
      if (body){
        body.innerHTML = `
          <p><strong>Datos:</strong></p>
          <ul class="list-disc pl-5">
            <li>Resistividad (ρ): ${fmt.num(p.resistividad)} Ω·m</li>
            <li>Longitud de jabalina (L): ${fmt.num(p.longitud)} m</li>
            <li>Diámetro de jabalina (d): ${fmt.num(p.diametro,3)} m</li>
            <li>Cantidad de jabalinas: ${fmt.num(p.n,0)}</li>
          </ul>
          <p class="mt-2"><strong>Fórmula:</strong> R = (ρ / 2πL) · ln(4L/d)</p>
          <p><strong>Resultados:</strong> R<sub>unitaria</sub> = ${fmt.ohms(r.R_unit)} | R<sub>equivalente</sub> = ${fmt.ohms(r.R_eq)}</p>
          <p><strong>Objetivo:</strong> ${fmt.ohms(r.objetivo)} — <strong>Estado:</strong> ${r.cumple ? "Cumple" : "No cumple"}</p>
        `;
      }
    }

    $("#tierraCalcBtn")?.addEventListener("click", renderTierra);

    $("#tierraCsvBtn")?.addEventListener("click", () => {
      const p = tierraParams();
      const r = calculatePat(p);
      const rows = [
        ["Parametro","Valor","Unidad"],
        ["Resistividad", p.resistividad, "Ω·m"],
        ["Longitud", p.longitud, "m"],
        ["Diámetro", p.diametro, "m"],
        ["Jabalinas (n)", p.n, "—"],
        ["R (unitaria)", r.R_unit, "Ω"],
        ["R (equivalente)", r.R_eq, "Ω"],
        ["Objetivo", r.objetivo, "Ω"],
        ["Cumple", r.cumple ? "SI":"NO", "—"]
      ];
      download("tierra.csv", toCSV(rows));
    });

    $("#tierraTxtBtn")?.addEventListener("click", () => {
      const p = tierraParams();
      const r = calculatePat(p);
      const txt = `Memoria de cálculo — Puesta a Tierra
--------------------------------------------------
Datos
- ρ: ${p.resistividad} Ω·m
- L: ${p.longitud} m
- d: ${p.diametro} m
- n: ${p.n}

Fórmula
R = (ρ / 2πL) · ln(4L/d)

Resultados
- R (unitaria): ${r.R_unit.toFixed(2)} Ω
- R (equivalente): ${r.R_eq.toFixed(2)} Ω
- Objetivo: ${r.objetivo} Ω
- Cumple: ${r.cumple ? "SI" : "NO"}
`;
      download("tierra.txt", txt);
      // Mostrar bloque imprimible para PDF si el usuario quiere
      $("#tierraMemoria")?.classList.remove("hidden");
    });

    // ===================== domain/cables (placeholder de ejemplo) =====================
    function calcCables({I,V,L}){
      // Placeholder: caída de tensión simple ΔV = I·R (sección fija simulada)
      // Solo a modo de estructura; se reemplaza con tu lógica real.
      const R_km = 7.41; // Ω/km cobre 2.5mm2 aprox (placeholder)
      const R = R_km/1000 * L;
      const dV = I * R;
      const pct = V ? (dV/V*100) : 0;
      return { R, dV, pct };
    }
    function cablesParams(){
      return {
        I: Number($("#c_i")?.value || 25),
        V: Number($("#c_v")?.value || 220),
        L: Number($("#c_l")?.value || 30),
      };
    }
    function renderCables(){
      const p = cablesParams();
      const r = calcCables(p);
      $("#cablesResultado").innerHTML = `
        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <div class="text-sm muted">Resistencia tramo</div>
            <div class="font-semibold">${fmt.ohms(r.R)}</div>
          </div>
          <div>
            <div class="text-sm muted">Caída de tensión</div>
            <div class="font-semibold">${fmt.num(r.dV,2)} V</div>
          </div>
          <div>
            <div class="text-sm muted">% caída</div>
            <div class="font-semibold">${fmt.num(r.pct,2)} %</div>
          </div>
        </div>
      `;
      $("#cablesMemoriaBody").innerHTML = `
        <p><strong>Datos:</strong> I=${fmt.num(p.I)} A | V=${fmt.num(p.V)} V | L=${fmt.num(p.L)} m</p>
        <p><strong>Resultados:</strong> R=${fmt.ohms(r.R)} | ΔV=${fmt.num(r.dV,2)} V | ${fmt.num(r.pct,2)}%</p>
      `;
    }
    $("#cablesCsvBtn")?.addEventListener("click", () => {
      const p = cablesParams(); const r = calcCables(p);
      const rows = [
        ["Parametro","Valor","Unidad"],
        ["I", p.I, "A"],
        ["V", p.V, "V"],
        ["L", p.L, "m"],
        ["R tramo", r.R, "Ω"],
        ["ΔV", r.dV, "V"],
        ["% caída", r.pct, "%"],
      ];
      download("cables.csv", toCSV(rows));
    });
    $("#cablesTxtBtn")?.addEventListener("click", () => {
      const p = cablesParams(); const r = calcCables(p);
      const txt = `Memoria de cálculo — Cables
--------------------------------------------------
Datos
- I: ${p.I} A
- V: ${p.V} V
- L: ${p.L} m

Resultados
- R tramo: ${r.R.toFixed(3)} Ω
- ΔV: ${r.dV.toFixed(2)} V
- % caída: ${r.pct.toFixed(2)} %
`;
      download("cables.txt", txt);
      $("#cablesMemoria")?.classList.remove("hidden");
    });

    // Re-render on input change (simple UX)
    ["pat_resistividad","pat_longitud","pat_diametro","pat_n"].forEach(id=>{
      $("#"+id)?.addEventListener("change", renderTierra);
      $("#"+id)?.addEventListener("input", ()=>{});
    });
    ["c_i","c_v","c_l"].forEach(id=>{
      $("#"+id)?.addEventListener("change", renderCables);
    });

    // Render inicial
    renderTierra();
    renderCables();

    // ======= AEA checks for Tierra =======
    function tierraParamsAEA(){
      const base = tierraParams();
      const Idn = Number($("#pat_idn")?.value || 0.03);
      const Ul = Number($("#pat_ul")?.value || 50);
      return { ...base, Idn, Ul };
    }
    function renderTierra(){
      const p = tierraParamsAEA();
      const r = calculatePat(p);
      const out = $("#tierraResultado");
      if (!out) return;

      const cond_touch = (r.R_eq * p.Idn) <= p.Ul;
      const cond_40 = r.R_eq <= 40; // recomendación habitual (TT residenciales)

      out.innerHTML = `
        <div class="grid sm:grid-cols-2 gap-3">
          <div>
            <div class="text-sm muted">R (una jabalina)</div>
            <div class="font-semibold">${fmt.ohms(r.R_unit)}</div>
          </div>
          <div>
            <div class="text-sm muted">R (equivalente)</div>
            <div class="font-semibold">${fmt.ohms(r.R_eq)}</div>
          </div>
          <div>
            <div class="text-sm muted">Condición AEA (R·IΔn ≤ U<sub>L</sub>)</div>
            <div class="font-semibold">${cond_touch ? "Cumple ✅" : "No cumple ❌"}</div>
          </div>
          <div>
            <div class="text-sm muted">Recomendación R≤40 Ω</div>
            <div class="font-semibold">${cond_40 ? "OK ✅" : "Mejorable ⚠️"}</div>
          </div>
        </div>
      `;

      const body = $("#tierraMemoriaBody");
      if (body){
        body.innerHTML = `
          <p><strong>Datos:</strong> ρ=${fmt.num(p.resistividad)} Ω·m | L=${fmt.num(p.longitud)} m | d=${fmt.num(p.diametro,3)} m | n=${fmt.num(p.n,0)} | IΔn=${fmt.num(p.Idn,3)} A | U<sub>L</sub>=${fmt.num(p.Ul,0)} V</p>
          <p><strong>Fórmula:</strong> R = (ρ / 2πL) · ln(4L/d)</p>
          <p><strong>Resultados:</strong> R<sub>unit</sub>=${fmt.ohms(r.R_unit)} | R<sub>eq</sub>=${fmt.ohms(r.R_eq)}</p>
          <p><strong>Verificación AEA:</strong> R·IΔn = ${(r.R_eq*p.Idn).toFixed(1)} V ≤ U<sub>L</sub> ${p.Ul} V → ${cond_touch ? "Cumple" : "No cumple"}; Recomendación 40 Ω → ${cond_40 ? "OK" : "No"}</p>
        `;
      }
    }

    
    // ======= AEA table for cables (extended up to 400 mm2) + RX mode =======
    const SECCIONES = [1.5,2.5,4,6,10,16,25,35,50,70,95,120,150,185,240,300,400];

    // V/A·km base monofásico (tabla AEA típica) hasta 120; >120 estimado por R/X con cosφ=0.8, senφ=0.6, multipolar
    const AEA_VAKM_BASE = {
      1.5:26, 2.5:15, 4:10, 6:6.5, 10:3.8, 16:2.4, 25:1.6, 35:1.2, 50:0.8, 70:0.6, 95:0.5, 120:0.4
    };

    // Resistividad (Ω·mm²/m) a 20°C
    const RHO = { cu: 0.017241, al: 0.028264 };
    function Rkm_from_section(sec, material="cu", tC=30){
      // temp correction ~ alpha*(t-20); alpha Cu ~ 0.00393/°C, Al ~ 0.00403/°C
      const alpha = material==="cu" ? 0.00393 : 0.00403;
      const R20 = (RHO[material]*1000)/sec; // Ω/km
      const R = R20 * (1 + alpha*(tC-20));
      return R;
    }
    function Xkm_typical(disp="multipolar"){
      // Valores típicos (Ω/km) en BT, referencias de catálogos/AEA: multipolar ~0.08; trébol ~0.07; plano ~0.10
      if (disp==="trefoil") return 0.07;
      if (disp==="plano") return 0.10;
      return 0.08;
    }

    function cablesParams(){
      const limSel = $("#c_lim")?.value || "5";
      const limPct = limSel==="custom" ? Number($("#c_lim_custom")?.value||5) : Number(limSel);
      return {
        I: Number($("#c_i")?.value || 25),
        V: Number($("#c_v")?.value || 380),
        L: Number($("#c_l")?.value || 30),
        sec: Number($("#c_sec")?.value || 2.5),
        uso: $("#c_uso")?.value || "fuerza",
        modo: $("#c_modo")?.value || "tabla",
        norma: $("#c_norma")?.value || "NM2473_cu",
        disp: $("#c_disp")?.value || "multipolar",
        fases: $("#c_fases")?.value || "tri",
        cosfi: Number($("#c_cosfi")?.value || 0.8),
        senfi: Number($("#c_senfi")?.value || 0.6),
        Rkm_override: Number($("#c_Rkm_override")?.value||0) || null,
        Xkm_override: Number($("#c_Xkm_override")?.value||0) || null,
        limPct
      };
    }

    function VAKM_from_table(sec){
      if (AEA_VAKM_BASE[sec]) return AEA_VAKM_BASE[sec];
      // Estimar a partir de R/X típicos con cos/sen por defecto
      const cosfi = 0.8, senfi = 0.6;
      const Rkm = Rkm_from_section(sec, "cu");
      const Xkm = Xkm_typical("multipolar");
      // monofásico: ΔV ≈ (R*cos + X*sin) * I * (2*L/1000); V/A·km ≈ 2*(R*cos + X*sin)
      return 2*(Rkm*cosfi + Xkm*senfi);
    }

    function calcDropTabla(p){
      const vakm = VAKM_from_table(p.sec);
      // Trifásico AEA ~ √3 factor; monofásico ~2; pero V/A·km tabla es MONO-LINEAL → usamos equivalentes:
      // Usaremos esquema: ΔV = k * I * vakm * (L/1000); k_mono=1, k_tri≈√3/2 ≈0.866 (ajuste práctico)
      const k = p.fases==="tri" ? 0.866 : 1.0;
      const drop = k * vakm * p.I * (p.L/1000);
      const pct = p.V ? (drop/p.V*100) : 0;
      return { drop, pct };
    }

    function materialFromNorma(norma){
      if (norma==="IRAM2178_al") return "al";
      return "cu";
    }

    function calcDropRX(p){
      const material = materialFromNorma(p.norma);
      const Rkm = p.Rkm_override ?? Rkm_from_section(p.sec, material);
      const Xkm = p.Xkm_override ?? Xkm_typical(p.disp);
      const k = p.fases==="tri" ? Math.sqrt(3) : 2; // longitud es unidireccional L
      const drop = k * p.I * ( (Rkm*p.cosfi + Xkm*p.senfi) * (p.L/1000) );
      const pct = p.V ? (drop/p.V*100) : 0;
      return { drop, pct, Rkm, Xkm };
    }

    function renderCables(){
      const p = cablesParams();
      const r = p.modo==="tabla" ? calcDropTabla(p) : calcDropRX(p);
      const lim = p.limPct;
      const ok = r.pct <= lim;

      $("#cablesResultado").innerHTML = `
        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <div class="text-sm muted">ΔV</div>
            <div class="font-semibold">${fmt.num(r.drop,2)} V</div>
          </div>
          <div>
            <div class="text-sm muted">% caída (límite ${lim}%)</div>
            <div class="font-semibold">${fmt.num(r.pct,2)} % — ${ok ? "OK ✅" : "Excede ❌"}</div>
          </div>
          <div>
            <div class="text-sm muted">Datos cable</div>
            <div class="font-semibold">
              ${p.modo==="tabla" ? `Tabla AEA (V/A·km)` : `R/km=${p.Rkm_override??fmt.num(r.Rkm,4)} · X/km=${p.Xkm_override??fmt.num(r.Xkm,4)}`}
            </div>
          </div>
        </div>
      `;
      $("#cablesMemoriaBody").innerHTML = `
        <p><strong>Datos:</strong> fases=${p.fases} | V=${fmt.num(p.V)} V | I=${fmt.num(p.I)} A | L=${fmt.num(p.L)} m | Sección=${p.sec} mm² | Norma=${p.norma} | Disp=${p.disp}</p>
        <p><strong>Modo:</strong> ${p.modo==="tabla" ? `Tabla AEA V/A·km=`+fmt.num(VAKM_from_table(p.sec),2) : `R/km=${fmt.num(r.Rkm,4)} Ω/km | X/km=${fmt.num(r.Xkm,4)} Ω/km | cosφ=${p.cosfi} | senφ=${p.senfi}`}</p>
        <p><strong>Resultado:</strong> ΔV=${fmt.num(r.drop,2)} V | ${fmt.num(r.pct,2)} % (límite ${lim}%) → ${ok ? "Cumple" : "No cumple"}</p>
      `;
    }

    function sugerirSeccion(){
      const p = cablesParams();
      for (const s of SECCIONES){
        const test = { ...p, sec: s };
        const r = test.modo==="tabla" ? calcDropTabla(test) : calcDropRX(test);
        if (r.pct <= p.limPct){
          $("#c_sec").value = String(s);
          renderCables();
          return;
        }
      }
      alert("Ninguna sección hasta 400 mm² cumple con el límite de caída indicado. Ajustá parámetros.");
    }

    // Populate section list
    const secSel = $("#c_sec");
    if (secSel && secSel.options.length===0){
      SECCIONES.forEach(s => {
        const o = document.createElement("option");
        o.value = String(s); o.textContent = String(s);
        secSel.appendChild(o);
      });
      secSel.value = "2.5";
    }

    $("#c_lim")?.addEventListener("change", ()=>{
      const val = $("#c_lim").value;
      $("#c_lim_custom_label")?.classList.toggle("hidden", val!=="custom");
      renderCables();
    });
    ["c_fases","c_modo","c_norma","c_disp","c_cosfi","c_senfi","c_sec"].forEach(id=> $("#"+id)?.addEventListener("change", renderCables));
    ["c_Rkm_override","c_Xkm_override"].forEach(id=> $("#"+id)?.addEventListener("input", renderCables));
    $("#c_sugerir")?.addEventListener("click", (e)=>{ e.preventDefault(); sugerirSeccion(); });
 =======
    function ccParams(){
      return {
        VLL: Number($("#cc_VLL")?.value || 380),
        esquema: $("#cc_esquema")?.value || "trifasico",
        Zth: Number($("#cc_Zth")?.value || 0.2),
        L: Number($("#cc_L")?.value || 30),
        Rkm: Number($("#cc_Rkm")?.value || 7.41),
        Xkm: Number($("#cc_Xkm")?.value || 0.08),
      };
    }
    function calcCC(p){
      const Vph = p.esquema === "trifasico" ? (p.VLL/Math.sqrt(3)) : (p.VLL);
      const R = p.Rkm/1000 * p.L;
      const X = p.Xkm/1000 * p.L;
      const Zline = Math.sqrt((R*R)+(X*X));
      const Z = p.Zth + Zline;
      const Ik = Vph / Z;
      return { Vph, R, X, Zline, Z, Ik };
    }
    function renderCC(){
      const p = ccParams();
      const r = calcCC(p);
      $("#ccResultado").innerHTML = `
        <div class="grid sm:grid-cols-3 gap-3">
          <div>
            <div class="text-sm muted">V<sub>fase</sub></div>
            <div class="font-semibold">${fmt.num(r.Vph,1)} V</div>
          </div>
          <div>
            <div class="text-sm muted">|Z| total</div>
            <div class="font-semibold">${fmt.ohms(r.Z)}</div>
          </div>
          <div>
            <div class="text-sm muted">I<sub>k</sub> (aprox)</div>
            <div class="font-semibold">${fmt.num(r.Ik,1)} A</div>
          </div>
        </div>
      `;
      // SVG unifilar
      const svg = `
      <svg width="100%" height="140" viewBox="0 0 600 140" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <style>
            .bus{stroke:#111827;stroke-width:3}
            .elem{fill:#fff;stroke:#111827;stroke-width:2}
            .label{font:12px Inter, sans-serif; fill:#111827}
          </style>
        </defs>
        <line x1="40" y1="70" x2="200" y2="70" class="bus"/>
        <rect x="200" y="50" width="80" height="40" rx="6" class="elem"/>
        <line x1="280" y1="70" x2="420" y2="70" class="bus"/>
        <circle cx="450" cy="70" r="18" class="elem"/>
        <text x="40" y="50" class="label">Fuente</text>
        <text x="210" y="45" class="label">TM</text>
        <text x="320" y="50" class="label">Línea</text>
        <text x="440" y="45" class="label">Carga</text>
      </svg>`;
      $("#ccSvg").innerHTML = svg;

      $("#ccMemoriaBody").innerHTML = `
        <p><strong>Datos:</strong> VLL=${fmt.num(p.VLL)} V | esquema=${p.esquema} | Zth=${fmt.ohms(p.Zth)} | L=${fmt.num(p.L)} m | R/km=${fmt.num(p.Rkm)} Ω/km | X/km=${fmt.num(p.Xkm)} Ω/km</p>
        <p><strong>Resultado:</strong> Vfase=${fmt.num(r.Vph)} V | Zline=${fmt.ohms(r.Zline)} | Ztotal=${fmt.ohms(r.Z)} | Ik=${fmt.num(r.Ik)} A</p>
      `;
    }
    ["cc_VLL","cc_esquema","cc_Zth","cc_L","cc_Rkm","cc_Xkm"].forEach(id=> $("#"+id)?.addEventListener("change", renderCC));
    $("#ccCsvBtn")?.addEventListener("click", ()=>{
      const p = ccParams(); const r = calcCC(p);
      const rows = [
        ["Parametro","Valor","Unidad"],
        ["VLL", p.VLL, "V"],["Esquema", p.esquema, ""],["Zth", p.Zth, "Ω"],
        ["L", p.L, "m"],["R/km", p.Rkm, "Ω/km"],["X/km", p.Xkm, "Ω/km"],
        ["Vfase", r.Vph, "V"],["Zline", r.Zline, "Ω"],["Ztotal", r.Z, "Ω"],["Ik", r.Ik, "A"],
      ];
      download("cortocircuito.csv", toCSV(rows));
      $("#ccMemoria")?.classList.remove("hidden");
    });
    $("#ccTxtBtn")?.addEventListener("click", ()=>{
      const p = ccParams(); const r = calcCC(p);
      const txt = `Memoria de cálculo — Cortocircuito
--------------------------------------------------
Datos
- VLL: ${p.VLL} V
- Esquema: ${p.esquema}
- Zth: ${p.Zth} Ω
- L: ${p.L} m
- R/km: ${p.Rkm} Ω/km
- X/km: ${p.Xkm} Ω/km

Resultados
- Vfase: ${r.Vph.toFixed(1)} V
- Zline: ${r.Zline.toFixed(4)} Ω
- Ztotal: ${r.Z.toFixed(4)} Ω
- Ik: ${r.Ik.toFixed(1)} A
`;
      download("cortocircuito.txt", txt);
      $("#ccMemoria")?.classList.remove("hidden");
    });
    renderCC();

  </script>
</body>
</html>
